<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Make A Match - Game Jamur</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      overflow: hidden;
      margin: 0;
      padding: 0;
      font-family: 'Fredoka', sans-serif;
    }
    #app {
      height: 100vh;
      width: 100vw;
      max-height: 100vh;
      max-width: 100vw;
    }
    .card-flip {
      perspective: 500px;
    }
    .card-inner {
      transition: transform 0.4s;
      transform-style: preserve-3d;
      position: relative;
      width: 100%;
      height: 100%;
    }
    .card-inner.flipped {
      transform: rotateY(180deg);
    }
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .card-back {
      transform: rotateY(180deg);
    }
    .matched {
      animation: matchPulse 0.4s ease;
    }
    @keyframes matchPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }
    .confetti {
      position: absolute;
      width: 6px;
      height: 6px;
      animation: confettiFall 1.5s ease-out forwards;
    }
    @keyframes confettiFall {
      0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    .sound-toggle {
      position: fixed;
      bottom: 6px;
      right: 6px;
      z-index: 50;
      padding: 4px 8px;
      font-size: 10px;
    }
    /* Animasi ucapan selamat level */
    .level-congrats {
      animation: levelCongrats 2s ease forwards;
      z-index: 100;
      pointer-events: none;
    }
    @keyframes levelCongrats {
      0% {
        transform: scale(0) translateY(30px);
        opacity: 0;
      }
      15% {
        transform: scale(1.05) translateY(0);
        opacity: 1;
      }
      85% {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
      100% {
        transform: scale(0) translateY(-30px);
        opacity: 0;
      }
    }
    /* Animasi applause */
    .applause-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .applause-container {
      text-align: center;
      animation: applauseScale 0.5s ease-out;
    }
    @keyframes applauseScale {
      0% { transform: scale(0.3); opacity: 0; }
      70% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .applause-text {
      font-size: 1.5rem;
      font-weight: 800;
      color: #FFD700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
      animation: textGlow 1s ease-in-out infinite alternate;
      margin-bottom: 6px;
    }
    @keyframes textGlow {
      from { 
        text-shadow: 0 0 8px rgba(255, 215, 0, 0.7), 
                     0 0 15px rgba(255, 215, 0, 0.5); 
      }
      to { 
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.9), 
                     0 0 25px rgba(255, 215, 0, 0.7),
                     0 0 35px rgba(255, 215, 0, 0.5); 
      }
    }
    
    /* Custom card styles */
    .card-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 2px;
      text-align: center;
      overflow: hidden;
    }
    
    .card-text {
      line-height: 1;
      font-weight: 600;
      word-break: break-word;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      text-align: center;
      padding: 1px;
    }
    
    /* Grid responsive untuk kartu - SANGAT KOMPAK */
    .game-board {
      display: grid;
      gap: 1px;
      padding: 0.5px;
      overflow: auto;
      width: 100%;
      height: 100%;
    }
    
    /* Custom scrollbar untuk game board */
    .game-board::-webkit-scrollbar {
      width: 1px;
      height: 1px;
    }
    
    .game-board::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.5px;
    }
    
    .game-board::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 0.5px;
    }
    
    .game-board::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Styling untuk dropdown custom */
    .custom-select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 0.8em;
    }
    
    /* Compact layout untuk fullscreen - LEBIH KOMPAK */
    .compact-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 2px;
      gap: 2px;
      overflow: hidden;
    }
    
    .compact-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2px;
      margin-bottom: 1px;
      flex-shrink: 0;
      padding: 2px;
    }
    
    .compact-game-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }
    
    /* Responsive untuk layar kecil */
    @media (max-width: 640px) {
      .grid-cols-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .applause-text {
        font-size: 1.2rem;
      }
      .card-text {
        font-size: 0.6rem;
      }
      .compact-container {
        padding: 1px;
        gap: 1px;
      }
      .sound-toggle {
        padding: 3px 6px;
        font-size: 9px;
      }
    }
    
    /* Untuk memastikan semua kartu terlihat */
    .board-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }
    
    /* Utility classes untuk spacing compact */
    .text-xxs {
      font-size: 0.6rem;
      line-height: 0.75rem;
    }
    
    .p-0\.5 {
      padding: 0.125rem;
    }
    
    .gap-0\.5 {
      gap: 0.125rem;
    }
    
    .text-3\.5xl {
      font-size: 2rem;
      line-height: 2.25rem;
    }
    
    /* Animasi untuk button hover */
    .btn-compact {
      transition: all 0.15s ease;
    }
    
    .btn-compact:hover {
      transform: scale(1.03);
    }
    
    /* Memastikan tidak ada overflow di body */
    html, body {
      max-height: 100%;
      max-width: 100%;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>
<body class="h-full">
<div id="app" class="h-full w-full overflow-hidden" style="background: linear-gradient(135deg, #1a2e1a 0%, #163e16 50%, #0f600f 100%);">
  
  <!-- Level Congratulation Modal -->
  <div id="levelCongratsModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
    <div class="level-congrats relative bg-gradient-to-r from-green-400 via-green-300 to-green-400 p-3 rounded-lg shadow-xl border-2 border-green-500 max-w-xs mx-2">
      <div class="text-center">
        <div class="text-3xl mb-1 animate-bounce">üèÜ</div>
        <h3 class="text-lg font-bold text-gray-800 mb-0.5">HEBAT!</h3>
        <p id="levelWinnerName" class="text-base font-bold text-purple-700 mb-0.5"></p>
        <p class="text-xs text-gray-700 mb-1">Pertama selesai!</p>
        <div class="flex items-center justify-center gap-0.5 text-sm text-gray-800">
          <span>‚≠ê</span>
          <span id="levelDifficultyText" class="font-bold"></span>
          <span>‚≠ê</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Applause Animation Overlay -->
  <div id="applauseOverlay" class="applause-overlay hidden">
    <div class="applause-container">
      <div class="text-5xl mb-2">üëèüéâ‚ú®</div>
      <div id="applauseText" class="applause-text"></div>
      <div class="text-base text-white font-semibold mt-1" id="applauseSubtext">Juara Level!</div>
    </div>
  </div>
  
  <!-- Sound Toggle Button -->
  <button onclick="toggleSound()" id="soundToggle" class="sound-toggle bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-full shadow-md transition-all transform hover:scale-110 flex items-center gap-0.5 btn-compact">
    <span id="soundIcon" class="text-xs">üîä</span>
  </button>
  
  <!-- Start Screen -->
  <div id="startScreen" class="h-full flex flex-col items-center justify-center p-2 overflow-auto">
    <!-- Judul Utama -->
    <div class="text-center mb-2">
      <h1 class="text-2xl md:text-3xl font-bold text-white mb-0.5 drop-shadow-lg">Make A Match</h1>
      <h2 class="text-xl md:text-2xl font-bold text-green-300 mb-0.5 drop-shadow-lg">Game Jamur</h2>
    </div>
    
    <!-- Container Compact -->
    <div class="compact-container w-full max-w-xs">
      
      <!-- Player Count Selection -->
      <div class="bg-white/10 backdrop-blur-sm rounded p-2">
        <h3 class="text-white font-semibold mb-1 text-center text-xs">üë• Jumlah Pemain</h3>
        <div class="grid grid-cols-3 gap-0.5">
          <button onclick="selectPlayerCount(1)" id="btn1Player" class="player-count-btn bg-blue-500 hover:bg-blue-400 text-white py-1 px-0.5 rounded font-semibold transition-all btn-compact border-b-2 border-blue-700">
            <span class="text-xxs block">1 Orang</span>
            <span class="text-[8px] block opacity-80 mt-0.25">Solo</span>
          </button>
          <button onclick="selectPlayerCount(2)" id="btn2Players" class="player-count-btn bg-purple-500 hover:bg-purple-400 text-white py-1 px-0.5 rounded font-semibold transition-all btn-compact border-b-2 border-purple-700 ring-1 ring-white">
            <span class="text-xxs block">2 Orang</span>
            <span class="text-[8px] block opacity-80 mt-0.25">Kompetisi</span>
          </button>
          <button onclick="selectPlayerCount(4)" id="btn4Players" class="player-count-btn bg-pink-500 hover:bg-pink-400 text-white py-1 px-0.5 rounded font-semibold transition-all btn-compact border-b-2 border-pink-700">
            <span class="text-xxs block">4 Orang</span>
            <span class="text-[8px] block opacity-80 mt-0.25">Tim</span>
          </button>
        </div>
      </div>
      
      <!-- Player Names -->
      <div id="playerNamesContainer" class="bg-white/10 backdrop-blur-sm rounded p-2">
        <h3 class="text-white font-semibold mb-1 text-center text-xs">üë• Nama Pemain</h3>
        <div id="playerInputs" class="space-y-1">
          <!-- Player inputs akan di-generate oleh JavaScript -->
        </div>
      </div>
      
      <!-- Level Selection Dropdown -->
      <div class="bg-white/10 backdrop-blur-sm rounded p-2">
        <h3 class="text-white font-semibold mb-1 text-center text-xs">üéÆ Pilih Level Jamur</h3>
        <div class="relative">
          <select id="levelDropdown" onchange="selectLevelFromDropdown()" class="custom-select w-full bg-white/20 text-white py-1.5 px-2 rounded border border-green-400/50 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-transparent text-xs appearance-none">
            <option value="ascomycota" class="bg-green-700 text-white text-xs">Level 1: Ascomycota</option>
            <option value="zygomycota" class="bg-yellow-700 text-white text-xs">Level 2: Zygomycota</option>
            <option value="basidiomycota" class="bg-red-700 text-white text-xs">Level 3: Basidiomycota</option>
            <option value="deuteromycota" class="bg-blue-700 text-white text-xs">Level 4: Deuteromycota</option>
            <option value="chytridiomycota" class="bg-purple-700 text-white text-xs">Level 5: Chytridiomycota</option>
          </select>
        </div>
      </div>
      
      <!-- Difficulty Selection Dropdown -->
      <div class="bg-white/10 backdrop-blur-sm rounded p-2">
        <h3 class="text-white font-semibold mb-1 text-center text-xs">üéØ Tingkat Kesulitan</h3>
        <div class="relative">
          <select id="difficultyDropdown" onchange="selectDifficultyFromDropdown()" class="custom-select w-full bg-white/20 text-white py-1.5 px-2 rounded border border-green-400/50 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-transparent text-xs appearance-none">
            <option value="easy" class="bg-green-700 text-white text-xs">Mudah (5 pasang)</option>
            <option value="medium" class="bg-yellow-700 text-white text-xs" selected>Sedang (8 pasang)</option>
            <option value="hard" class="bg-red-700 text-white text-xs">Sulit (10 pasang)</option>
          </select>
        </div>
      </div>
      
      <!-- Start Button -->
      <button onclick="startGame()" id="startBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-1.5 px-4 rounded transition-all btn-compact shadow-md text-xs">
        üöÄ Mulai Game
      </button>
      
      <!-- Instructions -->
      <div class="text-center text-gray-300 text-[8px]">
        <p class="mb-0.25">üìã <strong class="text-white">Cara Main:</strong> Temukan pasangan kartu ciri-ciri dan contoh jamur!</p>
      </div>
    </div>
  </div>
  
  <!-- Game Screen -->
  <div id="gameScreen" class="h-full hidden compact-container">
    <!-- Header -->
    <div class="compact-header">
      <button onclick="backToMenu()" class="bg-white/20 hover:bg-white/30 text-white px-1 py-0.5 rounded transition-all flex items-center gap-0.5 text-[9px] btn-compact">
        ‚Üê Menu
      </button>
      <div class="flex items-center gap-0.5 bg-white/10 px-1 py-0.5 rounded">
        <span id="currentLevelIcon" class="text-green-300 text-[10px]">üçÑ</span>
        <span id="currentLevel" class="text-white font-bold text-[9px] truncate max-w-[50px]">Ascomycota</span>
      </div>
      <div class="flex items-center gap-0.5 bg-white/10 px-1 py-0.5 rounded">
        <span class="text-yellow-300 text-[10px]">‚è±Ô∏è</span>
        <span id="timer" class="text-white font-mono text-[9px]">00:00</span>
      </div>
    </div>
    
    <!-- Score Board Compact -->
    <div id="scoreBoard" class="grid grid-cols-2 gap-0.5 flex-shrink:0 px-0.5">
      <!-- Score cards akan di-generate oleh JavaScript -->
    </div>
    
    <!-- Game Boards Area -->
    <div class="compact-game-area px-0.5">
      <!-- Game Boards -->
      <div id="gameBoardsContainer" class="flex-1 grid grid-cols-2 gap-0.5 min-h-0 overflow-hidden">
        <!-- Game boards akan di-generate oleh JavaScript -->
      </div>
    </div>
    
    <!-- Status Board -->
    <div id="statusBoard" class="grid grid-cols-2 gap-0.5 flex-shrink:0 px-0.5">
      <!-- Status bars akan di-generate oleh JavaScript -->
    </div>
    
    <!-- Info Panel -->
    <div id="infoPanel" class="bg-white/10 backdrop-blur-sm rounded p-0.5 text-center hidden flex-shrink:0 mx-0.5">
      <p id="infoText" class="text-white text-[9px]"></p>
    </div>
  </div>
  
  <!-- Result Screen Compact -->
  <div id="resultScreen" class="h-full w-full flex flex-col items-center justify-center p-0.5 fixed inset-0 hidden z-50 overflow-auto" style="background: linear-gradient(135deg, #1a2e1a 0%, #163e16 50%, #0f600f 100%);">
    <div id="confettiContainer" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
    <div class="text-center z-30 w-full flex flex-col items-center justify-center max-w-xs px-0.5 py-1">
      
      <!-- Winner Announcement -->
      <div class="mb-1 flex justify-center">
        <span class="text-3xl block animate-bounce">üéä</span>
      </div>
      
      <div id="winnerAnnouncement" class="mb-1 bg-gradient-to-r from-green-400/20 to-green-500/20 border border-green-400/50 rounded p-1 w-full">
        <p id="winnerMessageLevel" class="text-xs text-yellow-300 font-bold mb-0.25"></p>
        <p class="text-[10px] text-white font-semibold">Pemenang! üèÖ</p>
      </div>
      
      <h2 class="text-base font-bold text-white mb-0.25 drop-shadow-lg">SELAMAT!</h2>
      <p id="winnerName" class="text-lg font-bold bg-gradient-to-r from-green-300 to-green-500 bg-clip-text text-transparent mb-0.5 px-0.5 drop-shadow-lg truncate w-full"></p>
      
      <!-- Results Card Compact -->
      <div class="bg-white/15 backdrop-blur-sm rounded-lg p-1 mb-1 w-full border border-white/20 shadow-md">
        <h3 class="text-xs text-white font-bold mb-1 pb-0.5 border-b border-white/20">üìä Hasil Game</h3>
        <div id="resultsContainer" class="space-y-0.5 mb-1">
          <!-- Results akan di-generate oleh JavaScript -->
        </div>
        
        <!-- Stats Grid Compact -->
        <div class="grid grid-cols-4 gap-0.5 pt-1 border-t border-white/20">
          <div class="flex flex-col items-center bg-white/10 rounded p-0.5">
            <span class="text-xs mb-0.25">‚è±Ô∏è</span>
            <span class="text-gray-300 text-[7px] font-medium">Waktu</span>
            <span id="resultTime" class="font-mono text-[9px] font-bold text-yellow-300 mt-0.25"></span>
          </div>
          <div class="flex flex-col items-center bg-white/10 rounded p-0.5">
            <span class="text-xs mb-0.25">üéØ</span>
            <span class="text-gray-300 text-[7px] font-medium">Level</span>
            <span id="resultLevel" class="text-[9px] font-bold text-yellow-300 mt-0.25 truncate w-full text-center"></span>
          </div>
          <div class="flex flex-col items-center bg-white/10 rounded p-0.5">
            <span class="text-xs mb-0.25">üìä</span>
            <span class="text-gray-300 text-[7px] font-medium">Kesulitan</span>
            <span id="resultDifficulty" class="text-[9px] font-bold text-yellow-300 mt-0.25 truncate w-full text-center"></span>
          </div>
          <div class="flex flex-col items-center bg-white/10 rounded p-0.5">
            <span class="text-xs mb-0.25">üé¥</span>
            <span class="text-gray-300 text-[7px] font-medium">Kartu</span>
            <span id="resultCards" class="text-[9px] font-bold text-yellow-300 mt-0.25"></span>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons Compact -->
      <div class="flex gap-0.5 justify-center w-full">
        <button onclick="restartGame()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-1 px-1 rounded transition-all btn-compact shadow hover:shadow-green-600/50 border border-green-300/50 text-[9px] flex items-center justify-center gap-0.25">
          <span class="text-xs">üîÑ</span>
          Main Lagi
        </button>
        <button onclick="backToMenu()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-1 px-1 rounded transition-all btn-compact shadow hover:shadow-blue-600/50 border border-blue-300/50 text-[9px] flex items-center justify-center gap-0.25">
          <span class="text-xs">üìã</span>
          Menu
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Sound Effects using Web Audio API
  const soundManager = {
    audioContext: null,
    soundEnabled: true,
    
    init() {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    },
    
    playFlipSound() {
      if (!this.soundEnabled) return;
      if (!this.audioContext) this.init();
      const ctx = this.audioContext;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.frequency.setValueAtTime(450, ctx.currentTime);
      osc.frequency.setValueAtTime(550, ctx.currentTime + 0.06);
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      gain.gain.setValueAtTime(0, ctx.currentTime + 0.06);
      
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.06);
    },
    
    playMatchSound() {
      if (!this.soundEnabled) return;
      if (!this.audioContext) this.init();
      const ctx = this.audioContext;
      const notes = [523.25, 659.25, 783.99];
      
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(0.12, ctx.currentTime + i * 0.06);
        gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.06 + 0.1);
        
        osc.start(ctx.currentTime + i * 0.06);
        osc.stop(ctx.currentTime + i * 0.06 + 0.1);
      });
    },
    
    playMissSound() {
      if (!this.soundEnabled) return;
      if (!this.audioContext) this.init();
      const ctx = this.audioContext;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.frequency.setValueAtTime(280, ctx.currentTime);
      osc.frequency.setValueAtTime(180, ctx.currentTime + 0.12);
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      gain.gain.setValueAtTime(0, ctx.currentTime + 0.12);
      
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.12);
    },
    
    playWinSound() {
      if (!this.soundEnabled) return;
      if (!this.audioContext) this.init();
      const ctx = this.audioContext;
      const notes = [523.25, 659.25, 783.99, 1046.5];
      
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.1);
        gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.1 + 0.12);
        
        osc.start(ctx.currentTime + i * 0.1);
        osc.stop(ctx.currentTime + i * 0.1 + 0.12);
      });
    },
    
    playButtonClick() {
      if (!this.soundEnabled) return;
      if (!this.audioContext) this.init();
      const ctx = this.audioContext;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.frequency.setValueAtTime(800, ctx.currentTime);
      osc.frequency.setValueAtTime(850, ctx.currentTime + 0.03);
      gain.gain.setValueAtTime(0.12, ctx.currentTime);
      gain.gain.setValueAtTime(0, ctx.currentTime + 0.03);
      
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.03);
    },
    
    playLevelCompleteSound() {
      if (!this.soundEnabled) return;
      if (!this.audioContext) this.init();
      const ctx = this.audioContext;
      const notes = [659.25, 830.61, 987.77, 1174.66];
      
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(0.2, ctx.currentTime + i * 0.08);
        gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.08 + 0.2);
        
        osc.start(ctx.currentTime + i * 0.08);
        osc.stop(ctx.currentTime + i * 0.08 + 0.2);
      });
    },
    
    playApplauseSound() {
      if (!this.soundEnabled) return;
      if (!this.audioContext) this.init();
      const ctx = this.audioContext;
      
      // Create applause effect
      for (let i = 0; i < 2; i++) {
        setTimeout(() => {
          const notes = [392, 440, 494, 523];
          notes.forEach((freq, j) => {
            setTimeout(() => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              
              osc.connect(gain);
              gain.connect(ctx.destination);
              
              osc.frequency.setValueAtTime(freq, ctx.currentTime);
              gain.gain.setValueAtTime(0.1, ctx.currentTime);
              gain.gain.setValueAtTime(0, ctx.currentTime + 0.2);
              
              osc.start(ctx.currentTime);
              osc.stop(ctx.currentTime + 0.2);
            }, j * 30);
          });
        }, i * 120);
      }
    }
  };

  function toggleSound() {
    soundManager.soundEnabled = !soundManager.soundEnabled;
    const toggle = document.getElementById('soundToggle');
    const icon = document.getElementById('soundIcon');
    
    if (soundManager.soundEnabled) {
      icon.textContent = 'üîä';
      toggle.classList.remove('from-gray-500', 'to-gray-600');
      toggle.classList.add('from-green-500', 'to-emerald-600');
    } else {
      icon.textContent = 'üîá';
      toggle.classList.remove('from-green-500', 'to-emerald-600');
      toggle.classList.add('from-gray-500', 'to-gray-600');
    }
  }

  // Game Data untuk Jamur (TANPA ICON)
  const fungiData = {
    ascomycota: {
      name: "Ascomycota",
      icon: "üçÑ",
      color: "from-green-500 to-emerald-600",
      cardFrontIcon: "üçÑ",
      levelNumber: "Level 1",
      description: "Jamur kantung dengan askus sebagai alat reproduksi.",
      characteristics: [
        { name: "Sac Fungi", description: "Memiliki askus" },
        { name: "Askus", description: "Penghasil askospora" },
        { name: "Askospora", description: "Spora dalam askus" },
        { name: "Hifa bersekat", description: "Hifa dengan septa" },
        { name: "Saprofit/parasit", description: "Nutrisi dari organisme lain" },
        { name: "Saccharomyces", description: "Ragi untuk fermentasi" },
        { name: "Penicillium", description: "Pembuat antibiotik" },
        { name: "Aspergillus", description: "Pembuat kecap" },
        { name: "Neurospora", description: "Jamur oncom" },
        { name: "Miselium kompleks", description: "Jaringan hifa bercabang" }
      ]
    },
    zygomycota: {
      name: "Zygomycota",
      icon: "üçÑ",
      color: "from-yellow-500 to-amber-600",
      cardFrontIcon: "üçÑ",
      levelNumber: "Level 2",
      description: "Jamur konjugasi dengan hifa tidak bersekat.",
      characteristics: [
        { name: "Jamur konjugasi", description: "Reproduksi dengan konjugasi" },
        { name: "Zigosporangium", description: "Reproduksi seksual" },
        { name: "Hifa aseptat", description: "Hifa tidak bersekat" },
        { name: "Rizoid", description: "Pelekat dan penyerap" },
        { name: "Stolon", description: "Hifa horizontal" },
        { name: "Rhizopus", description: "Jamur tempe" },
        { name: "Mucor", description: "Jamur keju & roti" },
        { name: "Saprofit", description: "Pengurai organik" },
        { name: "Zigospora", description: "Spora berdinding tebal" },
        { name: "Sporangiofor", description: "Tangkai sporangium" }
      ]
    },
    basidiomycota: {
      name: "Basidiomycota",
      icon: "üçÑ",
      color: "from-red-500 to-rose-600",
      cardFrontIcon: "üçÑ",
      levelNumber: "Level 3",
      description: "Jamur klub dengan basidium.",
      characteristics: [
        { name: "Club Fungi", description: "Memiliki basidium" },
        { name: "Basidium", description: "Penghasil basidiospora" },
        { name: "Basidiospora", description: "Spora pada basidium" },
        { name: "Tubuh buah besar", description: "Badan buah makroskopis" },
        { name: "Hifa bersekat", description: "Dengan septa berpore" },
        { name: "Amanita", description: "Jamur beracun" },
        { name: "Volvariella", description: "Jamur merang" },
        { name: "Auricularia", description: "Jamur kuping" },
        { name: "Parasit/saprofit", description: "Nutrisi dari inang/mati" },
        { name: "Misellium sekunder", description: "Hifa dikaryotik" }
      ]
    },
    deuteromycota: {
      name: "Deuteromycota",
      icon: "üçÑ",
      color: "from-blue-500 to-cyan-600",
      cardFrontIcon: "üçÑ",
      levelNumber: "Level 4",
      description: "Jamur tidak sempurna.",
      characteristics: [
        { name: "Jamur tidak sempurna", description: "Reproduksi seksual belum diketahui" },
        { name: "Fungi imperfecti", description: "Nama lain deuteromycota" },
        { name: "Reproduksi aseksual", description: "Hanya dengan konidia" },
        { name: "Hifa bersekat", description: "Seperti ascomycota" },
        { name: "Konidiofor", description: "Penghasil konidia" },
        { name: "Monilia", description: "Penyebab penyakit buah" },
        { name: "Epidermophyton", description: "Penyebab kaki atlet" },
        { name: "Microsporum", description: "Penyakit kurap" },
        { name: "Saprofit/patogen", description: "Pengurai atau patogen" },
        { name: "Fase seksual", description: "Bisa dipindah divisi" }
      ]
    },
    chytridiomycota: {
      name: "Chytridiomycota",
      icon: "üçÑ",
      color: "from-purple-500 to-violet-600",
      cardFrontIcon: "üçÑ",
      levelNumber: "Level 5",
      description: "Jamur primitif dengan zoospora berflagel.",
      characteristics: [
        { name: "Jamur primitif", description: "Paling sederhana" },
        { name: "Zoospora berflagel", description: "Spora berflagel" },
        { name: "Reproduksi", description: "Zoospora dan gamet" },
        { name: "Dinding kitin", description: "Selulosa dan kitin" },
        { name: "Uniseluler/koloni", description: "Tubuh sederhana" },
        { name: "Allomyces", description: "Jamur air" },
        { name: "Synchytrium", description: "Parasit kentang" },
        { name: "Habitat lembab", description: "Tempat hidup lembab" },
        { name: "Parasit/saprofit", description: "Nutrisi dari inang/mati" },
        { name: "Gamet biflagel", description: "Gamet berenang aktif" }
      ]
    }
  };

  // Game State
  let playerCount = 2;
  let selectedLevel = 'ascomycota';
  let selectedDifficulty = 'medium'; // default: Sedang

  const playerColors = [
    { icon: "üîµ", bg: "from-cyan-600 to-cyan-500", text: "text-cyan-300", board: "from-cyan-600/20 to-cyan-400/10", border: "border-cyan-500/30" },
    { icon: "üü†", bg: "from-pink-600 to-pink-500", text: "text-pink-300", board: "from-pink-600/20 to-pink-400/10", border: "border-pink-500/30" },
    { icon: "üü¢", bg: "from-emerald-600 to-emerald-500", text: "text-emerald-300", board: "from-emerald-600/20 to-emerald-400/10", border: "border-emerald-500/30" },
    { icon: "üü£", bg: "from-purple-600 to-purple-500", text: "text-purple-300", board: "from-purple-600/20 to-purple-400/10", border: "border-purple-500/30" }
  ];

  let gameState = {
    level: null,
    playerCount: 2,
    players: [],
    timer: 0,
    timerInterval: null,
    targetPairs: 8, // Default: Sedang
    playerStates: [],
    firstLevelCompletion: false,
    isShowingApplause: false
  };

  const defaultConfig = {
    game_title: "Make A Match - Game Jamur"
  };
  let config = { ...defaultConfig };

  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange: async (newConfig) => {
        config = { ...defaultConfig, ...newConfig };
        document.getElementById('gameTitle').textContent = `üçÑ ${config.game_title}`;
      },
      mapToCapabilities: (config) => ({
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (config) => new Map([
        ["game_title", config.game_title || defaultConfig.game_title]
      ])
    });
  }

  function selectDifficultyFromDropdown() {
    soundManager.playButtonClick();
    const dropdown = document.getElementById('difficultyDropdown');
    selectedDifficulty = dropdown.value;
    
    // Update targetPairs berdasarkan kesulitan
    const difficultyMap = {
      easy: 5,
      medium: 8,
      hard: 10
    };
    
    gameState.targetPairs = difficultyMap[selectedDifficulty] || 8;
  }

  function showLevelCongrats(playerName) {
    const modal = document.getElementById('levelCongratsModal');
    const levelWinnerName = document.getElementById('levelWinnerName');
    const levelDifficultyText = document.getElementById('levelDifficultyText');
    
    levelWinnerName.textContent = playerName;
    
    const levelData = fungiData[gameState.level];
    const levelText = levelData ? levelData.name : 'Jamur';
    levelDifficultyText.textContent = levelText;
    
    modal.classList.remove('hidden');
    soundManager.playLevelCompleteSound();
    
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 2000);
  }

  function showApplause(playerName) {
    if (gameState.isShowingApplause) return;
    
    gameState.isShowingApplause = true;
    const overlay = document.getElementById('applauseOverlay');
    const applauseText = document.getElementById('applauseText');
    
    const shortName = playerName.length > 8 ? playerName.substring(0, 6) + "..." : playerName;
    applauseText.textContent = `${shortName.toUpperCase()}!`;
    
    overlay.classList.remove('hidden');
    soundManager.playApplauseSound();
    
    setTimeout(() => {
      overlay.classList.add('hidden');
      gameState.isShowingApplause = false;
    }, 2500);
  }

  function selectPlayerCount(count) {
    soundManager.playButtonClick();
    playerCount = count;
    gameState.playerCount = count;
    
    document.querySelectorAll('.player-count-btn').forEach(btn => {
      btn.classList.remove('ring-1', 'ring-white');
    });
    
    const btnId = `btn${count}Player${count > 1 ? 's' : ''}`;
    document.getElementById(btnId).classList.add('ring-1', 'ring-white');
    
    updatePlayerInputs();
  }

  function updatePlayerInputs() {
    const container = document.getElementById('playerInputs');
    container.innerHTML = '';
    
    for (let i = 0; i < playerCount; i++) {
      const color = playerColors[i];
      const inputId = `player${i+1}Name`;
      const placeholder = i === 0 ? "Pemain 1" : i === 1 ? "Pemain 2" : i === 2 ? "Pemain 3" : "Pemain 4";
      
      const inputHTML = `
        <div class="flex items-center gap-1">
          <span class="text-[10px]">${color.icon}</span>
          <input type="text" id="${inputId}" placeholder="${placeholder}" maxlength="8" 
                 class="flex-1 px-1.5 py-0.5 rounded bg-white/20 text-white placeholder-gray-300 border ${i === 0 ? 'border-cyan-500/50' : i === 1 ? 'border-pink-500/50' : i === 2 ? 'border-emerald-500/50' : 'border-purple-500/50'} focus:outline-none text-xxs focus:ring-0 focus:border-white/50">
        </div>
      `;
      container.innerHTML += inputHTML;
    }
  }

  function selectLevelFromDropdown() {
    soundManager.playButtonClick();
    const dropdown = document.getElementById('levelDropdown');
    selectedLevel = dropdown.value;
    gameState.level = selectedLevel;
  }

  function generateCards() {
    const cards = [];
    const levelData = fungiData[gameState.level];
    
    if (!levelData) {
      console.error('Level data not found:', gameState.level);
      return cards;
    }
    
    const characteristics = levelData.characteristics.slice(0, gameState.targetPairs);
    
    characteristics.forEach((char, index) => {
      cards.push({
        id: `char-${index}`,
        type: 'characteristic',
        pairId: index,
        content: char,
        levelData: levelData,
        levelKey: gameState.level
      });
      
      cards.push({
        id: `desc-${index}`,
        type: 'description',
        pairId: index,
        content: char,
        levelData: levelData,
        levelKey: gameState.level
      });
    });
    
    return cards.sort(() => Math.random() - 0.5);
  }

  function startGame() {
    soundManager.playButtonClick();
    
    if (!gameState.level) {
      alert('Pilih level jamur terlebih dahulu!');
      return;
    }
    
    // Set targetPairs berdasarkan kesulitan yang dipilih
    const difficultyMap = {
      easy: 5,
      medium: 8,
      hard: 10
    };
    
    gameState.targetPairs = difficultyMap[selectedDifficulty] || 8; // default 8 jika tidak ada
    
    gameState.playerCount = playerCount;
    gameState.players = [];
    gameState.playerStates = [];
    
    for (let i = 0; i < playerCount; i++) {
      const input = document.getElementById(`player${i+1}Name`);
      const name = input ? input.value.trim() || `P${i+1}` : `P${i+1}`;
      const shortName = name.length > 6 ? name.substring(0, 5) + "." : name;
      
      gameState.players.push({
        name: shortName,
        score: 0
      });
      
      gameState.playerStates.push({
        matchedPairs: 0,
        flippedCards: [],
        isLocked: false,
        cards: []
      });
    }
    
    gameState.timer = 0;
    gameState.firstLevelCompletion = false;
    gameState.isShowingApplause = false;
    
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');
    document.getElementById('resultScreen').classList.add('hidden');
    document.getElementById('levelCongratsModal').classList.add('hidden');
    document.getElementById('applauseOverlay').classList.add('hidden');
    
    const levelData = fungiData[gameState.level];
    if (levelData) {
      document.getElementById('currentLevel').textContent = levelData.name;
      document.getElementById('currentLevelIcon').textContent = levelData.icon;
    }
    
    setupGameUI();
    renderBoard();
    startTimer();
  }

  function setupGameUI() {
    setupScoreBoard();
    setupStatusBoard();
    setupGameBoardsContainer();
  }

  function setupScoreBoard() {
    const scoreBoard = document.getElementById('scoreBoard');
    scoreBoard.innerHTML = '';
    
    if (playerCount === 1) {
      scoreBoard.className = 'grid grid-cols-1 gap-0.5';
    } else if (playerCount === 2) {
      scoreBoard.className = 'grid grid-cols-2 gap-0.5';
    } else if (playerCount === 4) {
      scoreBoard.className = 'grid grid-cols-4 gap-0.5';
    }
    
    for (let i = 0; i < playerCount; i++) {
      const color = playerColors[i];
      const playerNum = i + 1;
      
      const scoreCardHTML = `
        <div id="player${playerNum}Card" class="${color.bg} p-0.5 rounded text-white transition-all">
          <div class="flex items-center gap-0.5">
            <span class="text-[10px]">${color.icon}</span>
            <div class="flex-1 min-w-0">
              <p id="p${playerNum}NameDisplay" class="font-bold text-[9px] truncate">${gameState.players[i].name}</p>
              <div class="flex items-center gap-0.25">
                <span class="${color.text} text-[8px]">Skor:</span>
                <span id="p${playerNum}Score" class="text-xs font-bold">0</span>
              </div>
            </div>
          </div>
        </div>
      `;
      scoreBoard.innerHTML += scoreCardHTML;
    }
  }

  function setupStatusBoard() {
    const statusBoard = document.getElementById('statusBoard');
    statusBoard.innerHTML = '';
    
    if (playerCount === 1) {
      statusBoard.className = 'grid grid-cols-1 gap-0.5';
    } else if (playerCount === 2) {
      statusBoard.className = 'grid grid-cols-2 gap-0.5';
    } else if (playerCount === 4) {
      statusBoard.className = 'grid grid-cols-4 gap-0.5';
    }
    
    for (let i = 0; i < playerCount; i++) {
      const color = playerColors[i];
      const playerNum = i + 1;
      
      const statusHTML = `
        <div class="bg-gradient-to-r ${color.bg.replace('from-', 'from-').replace('to-', 'to-')}/30 rounded p-0.5 border ${color.border}">
          <div class="flex items-center justify-between mb-0.25">
            <span class="text-white font-semibold text-[8px]">Kecocokan:</span>
            <span id="p${playerNum}Matches" class="${color.text} font-bold text-[9px]">0/<span id="totalMatches${playerNum}">${gameState.targetPairs}</span></span>
          </div>
          <div class="bg-gray-800/30 rounded-full h-0.5 overflow-hidden">
            <div id="p${playerNum}MatchBar" class="h-full bg-gradient-to-r ${color.bg} transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
      `;
      statusBoard.innerHTML += statusHTML;
    }
  }

  function setupGameBoardsContainer() {
    const boardsContainer = document.getElementById('gameBoardsContainer');
    boardsContainer.innerHTML = '';
    
    if (playerCount === 1) {
      boardsContainer.className = 'flex-1 grid grid-cols-1 gap-0.5 min-h-0 overflow-hidden';
    } else if (playerCount === 2) {
      boardsContainer.className = 'flex-1 grid grid-cols-2 gap-0.5 min-h-0 overflow-hidden';
    } else if (playerCount === 4) {
      boardsContainer.className = 'flex-1 grid grid-cols-2 md:grid-cols-4 gap-0.5 min-h-0 overflow-hidden';
    }
    
    for (let i = 0; i < playerCount; i++) {
      const color = playerColors[i];
      const playerNum = i + 1;
      
      const boardHTML = `
        <div class="flex flex-col ${color.board} rounded p-0.25 border ${color.border} overflow-hidden">
          <h3 class="${color.text} font-bold text-center mb-0.25 text-[9px] truncate px-0.5">
            ${color.icon} <span id="p${playerNum}BoardName">${gameState.players[i].name}</span>
          </h3>
          <div id="gameBoard${playerNum}" class="game-board flex-1">
            <!-- Cards will be generated here -->
          </div>
        </div>
      `;
      boardsContainer.innerHTML += boardHTML;
    }
  }

  function renderBoard() {
    for (let i = 0; i < playerCount; i++) {
      const cards = generateCards();
      gameState.playerStates[i].cards = cards;
      renderPlayerBoard(i + 1, cards);
    }
  }

  function renderPlayerBoard(playerNum, cards) {
    const board = document.getElementById(`gameBoard${playerNum}`);
    if (!board) return;
    
    let cols, cardWidth, cardHeight, fontSize, iconSize;
    const totalCards = gameState.targetPairs * 2;
    
    // Optimize untuk full screen - lebih compact
    if (playerCount === 1) {
      // Solo play - gunakan semua space
      if (gameState.targetPairs <= 5) {
        cols = 5;
        cardWidth = 'w-14';
        cardHeight = 'h-16';
        fontSize = 'text-[9px]';
        iconSize = 'text-base';
      } else if (gameState.targetPairs <= 8) {
        cols = 4;
        cardWidth = 'w-16';
        cardHeight = 'h-18';
        fontSize = 'text-[9px]';
        iconSize = 'text-lg';
      } else {
        cols = 5;
        cardWidth = 'w-14';
        cardHeight = 'h-16';
        fontSize = 'text-[8px]';
        iconSize = 'text-base';
      }
    } else if (playerCount === 2) {
      // 2 pemain - bagi space jadi 2
      if (gameState.targetPairs <= 5) {
        cols = 5;
        cardWidth = 'w-10';
        cardHeight = 'h-12';
        fontSize = 'text-[8px]';
        iconSize = 'text-sm';
      } else if (gameState.targetPairs <= 8) {
        cols = 4;
        cardWidth = 'w-12';
        cardHeight = 'h-14';
        fontSize = 'text-[8px]';
        iconSize = 'text-base';
      } else {
        cols = 5;
        cardWidth = 'w-10';
        cardHeight = 'h-12';
        fontSize = 'text-[7px]';
        iconSize = 'text-sm';
      }
    } else if (playerCount === 4) {
      // 4 pemain - sangat compact
      if (gameState.targetPairs <= 5) {
        cols = 3;
        cardWidth = 'w-9';
        cardHeight = 'h-11';
        fontSize = 'text-[7px]';
        iconSize = 'text-sm';
      } else if (gameState.targetPairs <= 8) {
        cols = 4;
        cardWidth = 'w-8';
        cardHeight = 'h-10';
        fontSize = 'text-[7px]';
        iconSize = 'text-xs';
      } else {
        cols = 5;
        cardWidth = 'w-7';
        cardHeight = 'h-9';
        fontSize = 'text-[6px]';
        iconSize = 'text-xs';
      }
    } else {
      cols = 4;
      cardWidth = 'w-12';
      cardHeight = 'h-14';
      fontSize = 'text-[9px]';
      iconSize = 'text-base';
    }
    
    board.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
    board.style.gap = '1px';
    board.style.padding = '0.5px';
    board.innerHTML = '';
    
    cards.forEach((card, index) => {
      const cardElement = document.createElement('div');
      cardElement.className = `card-flip ${cardWidth} ${cardHeight} cursor-pointer`;
      cardElement.id = `${playerNum}-${card.id}`;
      cardElement.onclick = () => flipCard(playerNum, index);
      
      const isCharacteristic = card.type === 'characteristic';
      const bgColor = isCharacteristic ? 'bg-gradient-to-br from-slate-700 to-slate-800' : `bg-gradient-to-br ${card.levelData.color}`;
      
      const displayText = isCharacteristic ? card.content.name : card.content.description;
      
      cardElement.innerHTML = `
        <div class="card-inner">
          <div class="card-front bg-gradient-to-br from-green-600 to-emerald-700 border border-white/20">
            <div class="card-content">
              <div class="card-text">
                <span class="${iconSize}">üçÑ</span>
              </div>
            </div>
          </div>
          <div class="card-back ${bgColor} border border-white/30">
            <div class="card-content">
              <div class="card-text ${fontSize} font-bold leading-tight px-0.5">
                ${displayText}
              </div>
            </div>
          </div>
        </div>
      `;
      
      board.appendChild(cardElement);
    });
  }

  function flipCard(playerNum, index) {
    const playerIndex = playerNum - 1;
    const playerState = gameState.playerStates[playerIndex];
    
    if (!playerState || playerState.isLocked) return;
    
    const cards = playerState.cards;
    const card = cards[index];
    const cardElement = document.getElementById(`${playerNum}-${card.id}`);
    
    if (!cardElement) return;
    
    const cardInner = cardElement.querySelector('.card-inner');
    
    if (cardInner.classList.contains('flipped') || playerState.flippedCards.includes(index)) return;
    
    soundManager.playFlipSound();
    cardInner.classList.add('flipped');
    playerState.flippedCards.push(index);
    
    if (playerState.flippedCards.length === 2) {
      playerState.isLocked = true;
      setTimeout(() => checkMatch(playerNum), 400);
    }
  }

  function checkMatch(playerNum) {
    const playerIndex = playerNum - 1;
    const playerState = gameState.playerStates[playerIndex];
    const [first, second] = playerState.flippedCards;
    const cards = playerState.cards;
    
    if (!cards[first] || !cards[second]) {
      playerState.flippedCards = [];
      playerState.isLocked = false;
      return;
    }
    
    const card1 = cards[first];
    const card2 = cards[second];
    
    const isMatch = card1.pairId === card2.pairId && card1.type !== card2.type;
    
    if (isMatch) {
      soundManager.playMatchSound();
      const characteristicCard = card1.type === 'characteristic' ? card1 : card2;
      showInfo(`‚úÖ ${characteristicCard.content.name} (${gameState.players[playerIndex].name})`);
      
      gameState.players[playerIndex].score++;
      playerState.matchedPairs++;
      
      const el1 = document.getElementById(`${playerNum}-${card1.id}`);
      const el2 = document.getElementById(`${playerNum}-${card2.id}`);
      
      if (el1) el1.classList.add('matched');
      if (el2) el2.classList.add('matched');
      
      setTimeout(() => {
        if (el1) el1.style.visibility = 'hidden';
        if (el2) el2.style.visibility = 'hidden';
        
        playerState.flippedCards = [];
        playerState.isLocked = false;
        
        updateScores();
        updateCompetitiveStatus();
        hideInfo();
        
        checkWinner();
      }, 600);
    } else {
      soundManager.playMissSound();
      showInfo(`‚ùå Salah (${gameState.players[playerIndex].name})`);
      
      setTimeout(() => {
        const el1 = document.getElementById(`${playerNum}-${card1.id}`);
        const el2 = document.getElementById(`${playerNum}-${card2.id}`);
        if (el1 && el2) {
          el1.querySelector('.card-inner').classList.remove('flipped');
          el2.querySelector('.card-inner').classList.remove('flipped');
        }
        
        playerState.flippedCards = [];
        playerState.isLocked = false;
        hideInfo();
      }, 600);
    }
  }

  function showInfo(text) {
    const panel = document.getElementById('infoPanel');
    const infoText = document.getElementById('infoText');
    infoText.textContent = text;
    panel.classList.remove('hidden');
    setTimeout(hideInfo, 800);
  }

  function hideInfo() {
    document.getElementById('infoPanel').classList.add('hidden');
  }

  function updateScores() {
    for (let i = 0; i < playerCount; i++) {
      const scoreElement = document.getElementById(`p${i+1}Score`);
      if (scoreElement) {
        scoreElement.textContent = gameState.players[i].score;
      }
    }
  }

  function startTimer() {
    if (gameState.timerInterval) clearInterval(gameState.timerInterval);
    
    gameState.timerInterval = setInterval(() => {
      gameState.timer++;
      const mins = Math.floor(gameState.timer / 60).toString().padStart(2, '0');
      const secs = (gameState.timer % 60).toString().padStart(2, '0');
      document.getElementById('timer').textContent = `${mins}:${secs}`;
    }, 1000);
  }

  function stopTimer() {
    if (gameState.timerInterval) {
      clearInterval(gameState.timerInterval);
      gameState.timerInterval = null;
    }
  }

  function updateCompetitiveStatus() {
    const total = gameState.targetPairs;
    
    for (let i = 0; i < playerCount; i++) {
      const matchesElement = document.getElementById(`p${i+1}Matches`);
      const barElement = document.getElementById(`p${i+1}MatchBar`);
      
      if (matchesElement) {
        matchesElement.innerHTML = `${gameState.playerStates[i].matchedPairs}/<span id="totalMatches${i+1}">${total}</span>`;
      }
      
      if (barElement) {
        const percent = Math.round((gameState.playerStates[i].matchedPairs / total) * 100);
        barElement.style.width = `${percent}%`;
      }
    }
    
    let maxScore = -1;
    for (let i = 0; i < playerCount; i++) {
      if (gameState.playerStates[i].matchedPairs > maxScore) {
        maxScore = gameState.playerStates[i].matchedPairs;
      }
    }
    
    for (let i = 0; i < playerCount; i++) {
      const cardElement = document.getElementById(`player${i+1}Card`);
      if (cardElement) {
        if (gameState.playerStates[i].matchedPairs < maxScore) {
          cardElement.classList.add('opacity-60');
        } else {
          cardElement.classList.remove('opacity-60');
        }
      }
    }
  }

  function checkWinner() {
    let anyComplete = false;
    let firstCompleterIndex = -1;
    
    for (let i = 0; i < playerCount; i++) {
      const isComplete = gameState.playerStates[i].matchedPairs >= gameState.targetPairs;
      
      if (isComplete) {
        anyComplete = true;
        if (firstCompleterIndex === -1) {
          firstCompleterIndex = i;
        }
      }
    }
    
    if (anyComplete && !gameState.firstLevelCompletion) {
      gameState.firstLevelCompletion = true;
      
      if (firstCompleterIndex !== -1) {
        showApplause(gameState.players[firstCompleterIndex].name);
        
        setTimeout(() => {
          showLevelCongrats(gameState.players[firstCompleterIndex].name);
        }, 2600);
      }
      
      setTimeout(() => {
        stopTimer();
        
        let winnerIndex = 0;
        let maxPairs = gameState.playerStates[0].matchedPairs;
        
        for (let i = 1; i < playerCount; i++) {
          if (gameState.playerStates[i].matchedPairs > maxPairs) {
            maxPairs = gameState.playerStates[i].matchedPairs;
            winnerIndex = i;
          } else if (gameState.playerStates[i].matchedPairs === maxPairs) {
            if (gameState.players[i].score > gameState.players[winnerIndex].score) {
              winnerIndex = i;
            }
          }
        }
        
        for (let i = 1; i <= playerCount; i++) {
          const board = document.getElementById(`gameBoard${i}`);
          if (board) {
            board.style.pointerEvents = 'none';
            board.style.opacity = '0.5';
          }
        }
        
        setTimeout(() => showResults(winnerIndex), 400);
      }, 5000);
    }
  }

  function showResults(winnerIndex) {
    soundManager.playWinSound();
    const winner = gameState.players[winnerIndex];
    const levelData = fungiData[gameState.level];
    const levelText = levelData ? `${levelData.levelNumber}: ${levelData.name}` : 'Level Jamur';
    
    const difficultyTextMap = {
      easy: "Mudah (5 pasang)",
      medium: "Sedang (8 pasang)",
      hard: "Sulit (10 pasang)"
    };
    
    const difficultyText = difficultyTextMap[selectedDifficulty] || "Sedang (8 pasang)";
    const totalCards = gameState.targetPairs * 2;
    
    document.getElementById('gameScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    
    document.getElementById('winnerMessageLevel').textContent = `${winner.name} menang di ${levelText}!`;
    document.getElementById('winnerName').textContent = `${winner.name} Juara!`;
    
    document.getElementById('resultDifficulty').textContent = difficultyText;
    document.getElementById('resultCards').textContent = `${totalCards} kartu`;
    
    const resultsContainer = document.getElementById('resultsContainer');
    resultsContainer.innerHTML = '';
    
    for (let i = 0; i < playerCount; i++) {
      const color = playerColors[i];
      const playerNum = i + 1;
      
      const resultHTML = `
        <div class="flex justify-between items-center ${color.bg.replace('from-', 'from-').replace('to-', 'to-')}/50 p-0.5 rounded border ${color.border.replace('border-', 'border-')}/70">
          <div class="flex items-center gap-0.5">
            <span class="text-xs">${color.icon}</span>
            <span id="result${playerNum}Name" class="text-white font-bold text-[9px] truncate max-w-[60px]">${gameState.players[i].name}</span>
          </div>
          <span id="result${playerNum}Score" class="text-xs font-bold ${color.text} ${color.bg.replace('from-', 'bg-').split(' ')[0]}/40 px-0.5 py-0.25 rounded">${gameState.players[i].score} pasang</span>
        </div>
      `;
      resultsContainer.innerHTML += resultHTML;
    }
    
    const mins = Math.floor(gameState.timer / 60).toString().padStart(2, '0');
    const secs = (gameState.timer % 60).toString().padStart(2, '0');
    document.getElementById('resultTime').textContent = `${mins}:${secs}`;
    document.getElementById('resultLevel').textContent = levelText;
    
    createConfetti();
  }

  function createConfetti() {
    const container = document.getElementById('confettiContainer');
    container.innerHTML = '';
    
    const colors = ['#4ade80', '#22c55e', '#16a34a', '#15803d', '#14532d'];
    
    for (let i = 0; i < 20; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = `${Math.random() * 100}%`;
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDelay = `${Math.random() * 1}s`;
      confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      container.appendChild(confetti);
    }
  }

  function restartGame() {
    startGame();
  }

  function backToMenu() {
    soundManager.playButtonClick();
    stopTimer();
    document.getElementById('startScreen').classList.remove('hidden');
    document.getElementById('gameScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.add('hidden');
    document.getElementById('levelCongratsModal').classList.add('hidden');
    document.getElementById('applauseOverlay').classList.add('hidden');
    
    gameState.level = null;
  }

  document.addEventListener('DOMContentLoaded', function() {
    updatePlayerInputs();
    selectPlayerCount(2);
    selectDifficultyFromDropdown();
  });
</script>
</body>
</html>

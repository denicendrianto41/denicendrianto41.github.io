<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioExplorer Nusantara: Ekspedisi Endemik</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            overflow: hidden; 
        }
        
        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
        }

        /* Glassmorphism UI elements */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Filter Buttons Active State */
        .filter-btn.active {
            background-color: #059669; /* emerald-600 */
            color: white;
            border-color: #059669;
        }

        /* Leaflet Popup Custom Style */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 320px !important; 
        }

        .input-focus-ring:focus {
            outline: none;
            ring: 2px;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
            border-color: #10B981;
        }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #10B981;
            border-radius: 10px;
        }

        /* Leaderboard Table Styles */
        .leaderboard-table th {
            background-color: #f3f4f6;
            color: #374151;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 0.75rem;
            text-align: left;
        }
        .leaderboard-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }
        .rank-1 { color: #d97706; font-weight: bold; } /* Gold */
        .rank-2 { color: #9ca3af; font-weight: bold; } /* Silver */
        .rank-3 { color: #b45309; font-weight: bold; } /* Bronze */

        /* Pulsing animation for quiz markers */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pulse-marker {
            animation: pulse 1.5s infinite;
        }

        /* Bounce animation for result modal */
        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- MAP CONTAINER -->
    <div id="map"></div>

    <!-- UI LAYER -->
    <div class="absolute inset-0 pointer-events-none z-[1000] flex flex-col justify-between p-2 md:p-4">
        
        <!-- TOP HUD -->
        <div id="game-hud" class="hidden pointer-events-auto flex flex-col gap-2 w-full max-w-6xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 w-full">
                <!-- Player Profile -->
                <div class="glass-panel rounded-xl p-2 px-3 shadow-lg flex items-center gap-3 w-full md:w-auto">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 border-2 border-white shadow-sm">
                        <i class="fa-solid fa-user-astronaut text-lg"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Explorer</p>
                        <p id="player-name-display" class="text-blue-900 font-bold text-sm truncate">Guest</p>
                    </div>
                    <!-- Mobile Score -->
                    <div class="md:hidden text-right border-l pl-3 ml-2">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Skor</p>
                        <p id="score-display-mobile" class="text-emerald-600 font-bold text-lg leading-none">0</p>
                    </div>
                </div>

                <!-- Desktop Score -->
                <div class="hidden md:flex glass-panel rounded-xl p-2 px-6 shadow-lg items-center gap-8">
                    <div class="text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Level Saat Ini</p>
                        <p id="level-display" class="text-purple-700 font-bold text-lg">1: Eksplorasi Umum</p>
                    </div>
                    <div class="h-10 w-px bg-gray-300"></div>
                    <div class="text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Total Poin</p>
                        <p id="score-display" class="text-emerald-600 font-bold text-2xl leading-none">0</p>
                    </div>
                </div>
            </div>

            <!-- CONTROLS -->
            <div id="exploration-controls" class="hidden pointer-events-auto w-full transition-all duration-300">
                <div class="glass-panel rounded-xl p-3 shadow-lg flex flex-col md:flex-row justify-between items-center gap-3">
                    <div id="level1-filters" class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                        <button onclick="filterMarkers('all')" id="btn-all" class="filter-btn active px-4 py-1.5 rounded-full border border-gray-300 text-sm font-bold text-gray-600 hover:bg-gray-100 transition whitespace-nowrap">Semua</button>
                        <button onclick="filterMarkers('flora')" id="btn-flora" class="filter-btn px-4 py-1.5 rounded-full border border-gray-300 text-sm font-bold text-gray-600 hover:bg-gray-100 transition whitespace-nowrap"><i class="fa-solid fa-seedling mr-1 text-green-500"></i> Flora</button>
                        <button onclick="filterMarkers('fauna')" id="btn-fauna" class="filter-btn px-4 py-1.5 rounded-full border border-gray-300 text-sm font-bold text-gray-600 hover:bg-gray-100 transition whitespace-nowrap"><i class="fa-solid fa-paw mr-1 text-orange-500"></i> Fauna</button>
                    </div>
                    <div id="level2-indicator" class="hidden flex gap-2 items-center">
                         <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-bold border border-purple-200 shadow-sm"><i class="fa-solid fa-layer-group mr-1"></i> Zona Biogeografi</span>
                         <span class="text-xs text-gray-500 italic hidden md:inline">Klik hewan untuk melihat ciri khasnya</span>
                    </div>
                    <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                        <div class="text-right">
                            <p class="text-[10px] text-gray-500 font-bold uppercase">Target Misi</p>
                            <div class="flex items-center gap-2">
                                <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
                                </div>
                                <p id="explore-count" class="text-blue-700 font-bold text-sm">0/20</p>
                            </div>
                        </div>
                        <button id="btn-finish-explore" onclick="finishExploration()" disabled class="bg-gray-200 text-gray-400 px-5 py-2 rounded-lg font-bold shadow-none cursor-not-allowed transition flex items-center gap-2 text-sm">Lanjut <i class="fa-solid fa-lock"></i></button>
                    </div>
                </div>
            </div>
            
            <div id="quiz-hud-info" class="hidden pointer-events-auto self-end mt-2">
                 <div class="glass-panel rounded-full px-4 py-1 shadow-md flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-500 uppercase">Zona Target:</span>
                    <span id="zone-display-hud" class="text-sm font-bold text-purple-700">...</span>
                 </div>
            </div>
        </div>

        <!-- Clue Card -->
        <div id="clue-card" class="hidden pointer-events-auto w-full max-w-md mx-auto mb-4 transition-all duration-500 transform translate-y-0">
            <div class="glass-panel rounded-2xl shadow-2xl p-5 border-l-8 border-yellow-400 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-paw text-6xl"></i></div>
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-[10px] font-bold text-yellow-600 uppercase tracking-wider mb-1 bg-yellow-100 inline-block px-2 rounded">Misi Pencarian</h3>
                        <h2 id="species-quiz-name" class="text-xl font-bold text-gray-800">???</h2>
                        <p class="text-xs text-gray-500 italic mb-2" id="species-quiz-scientific">Scientific Name</p>
                    </div>
                    <div class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded" id="quiz-progress-badge">1/10</div>
                </div>
                <p id="species-quiz-desc" class="text-sm text-gray-700 mb-4 leading-relaxed border-t pt-2 mt-1">Menunggu data misi...</p>
                <div class="flex justify-between items-center gap-2">
                    <button onclick="toggleMapLayers()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition"><i class="fa-solid fa-layer-group"></i> Peta Zona</button>
                    <button id="hint-btn" onclick="showHint()" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition text-center"><i class="fa-regular fa-lightbulb"></i> Bantuan (-5 Poin)</button>
                </div>
                <div id="hint-text" class="hidden mt-3 p-2 bg-yellow-50 text-xs text-yellow-800 rounded border border-yellow-200 animate-pulse"></div>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 z-[3000] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="bg-gradient-to-br from-emerald-600 to-teal-700 p-8 text-center relative overflow-hidden">
                <i class="fa-solid fa-leaf text-white/20 text-9xl absolute -bottom-8 -left-8 transform rotate-12"></i>
                <h1 class="text-3xl font-bold text-white relative z-10 mb-1">BioExplorer</h1>
                <p class="text-emerald-100 text-sm relative z-10 font-medium tracking-wide">EKSPEDISI FLORA & FAUNA</p>
            </div>
            <div class="p-8">
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Lengkap</label>
                        <div class="relative">
                            <i class="fa-solid fa-user absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="input-name" required class="input-focus-ring block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg text-gray-800 font-semibold" placeholder="Nama Siswa">
                        </div>
                    </div>
                    
                    <!-- INPUT SEKOLAH -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Sekolah</label>
                        <div class="relative">
                            <i class="fa-solid fa-school absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="input-school" required class="input-focus-ring block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg text-gray-800 font-semibold" placeholder="Nama Sekolah">
                        </div>
                    </div>

                    <!-- DROPDOWN PROVINSI -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Provinsi</label>
                        <div class="relative">
                            <i class="fa-solid fa-map-location-dot absolute left-3 top-3 text-gray-400"></i>
                            <select id="input-province" required class="input-focus-ring block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg text-gray-800 font-semibold bg-white appearance-none cursor-pointer">
                                <option value="" disabled selected>Pilih Provinsi</option>
                                <option value="Nanggroe Aceh Darussalam">Nanggroe Aceh Darussalam</option>
                                <option value="Sumatera Utara">Sumatera Utara</option>
                                <option value="Sumatera Selatan">Sumatera Selatan</option>
                                <option value="Sumatera Barat">Sumatera Barat</option>
                                <option value="Bengkulu">Bengkulu</option>
                                <option value="Riau">Riau</option>
                                <option value="Kepulauan Riau">Kepulauan Riau</option>
                                <option value="Jambi">Jambi</option>
                                <option value="Lampung">Lampung</option>
                                <option value="Bangka Belitung">Bangka Belitung</option>
                                <option value="Kalimantan Barat">Kalimantan Barat</option>
                                <option value="Kalimantan Timur">Kalimantan Timur</option>
                                <option value="Kalimantan Selatan">Kalimantan Selatan</option>
                                <option value="Kalimantan Tengah">Kalimantan Tengah</option>
                                <option value="Kalimantan Utara">Kalimantan Utara</option>
                                <option value="Banten">Banten</option>
                                <option value="DKI Jakarta">DKI Jakarta</option>
                                <option value="Jawa Barat">Jawa Barat</option>
                                <option value="Jawa Tengah">Jawa Tengah</option>
                                <option value="Daerah Istimewa Yogyakarta">Daerah Istimewa Yogyakarta</option>
                                <option value="Jawa Timur">Jawa Timur</option>
                                <option value="Bali">Bali</option>
                                <option value="Nusa Tenggara Timur">Nusa Tenggara Timur</option>
                                <option value="Nusa Tenggara Barat">Nusa Tenggara Barat</option>
                                <option value="Gorontalo">Gorontalo</option>
                                <option value="Sulawesi Barat">Sulawesi Barat</option>
                                <option value="Sulawesi Tengah">Sulawesi Tengah</option>
                                <option value="Sulawesi Utara">Sulawesi Utara</option>
                                <option value="Sulawesi Tenggara">Sulawesi Tenggara</option>
                                <option value="Sulawesi Selatan">Sulawesi Selatan</option>
                                <option value="Maluku Utara">Maluku Utara</option>
                                <option value="Maluku">Maluku</option>
                                <option value="Papua Barat">Papua Barat</option>
                                <option value="Papua">Papua</option>
                                <option value="Papua Tengah">Papua Tengah</option>
                                <option value="Papua Pegunungan">Papua Pegunungan</option>
                                <option value="Papua Selatan">Papua Selatan</option>
                                <option value="Papua Barat Daya">Papua Barat Daya</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-3.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg transform hover:translate-y-[-1px] transition-all">
                        Mulai Petualangan
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- TUTORIAL MODAL -->
    <div id="tutorial-modal" class="hidden fixed inset-0 z-[2000] bg-black/70 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh]">
            <div class="h-40 bg-cover bg-center flex items-end relative" style="background-image: url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?q=80&w=1000&auto=format&fit=crop');">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                <div class="p-6 relative z-10 w-full">
                    <span class="bg-emerald-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide mb-2 inline-block">Tutorial</span>
                    <h1 id="tut-title" class="text-2xl font-bold text-white">Selamat Datang</h1>
                </div>
            </div>
            <div class="p-6 flex-1 overflow-y-auto custom-scroll" id="tutorial-content"></div>
            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                <div class="flex space-x-2" id="tutorial-dots"></div>
                <button id="tutorial-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-2.5 rounded-lg font-bold shadow-lg transition transform hover:scale-105">Lanjut</button>
            </div>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="hidden fixed inset-0 z-[2000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center animate-bounce-in">
            <div id="result-icon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-white"></div>
            <h2 id="result-title" class="text-2xl font-black mb-1 text-gray-800">Hebat!</h2>
            <p id="result-message" class="text-gray-600 text-sm mb-6 px-4">Tebakan Anda sangat akurat.</p>
            <div class="flex gap-3 mb-6">
                <div class="flex-1 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="text-[10px] text-gray-400 uppercase font-bold">Jarak</div>
                    <div id="result-distance" class="font-mono font-bold text-lg text-gray-700">0 km</div>
                </div>
                <div class="flex-1 bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                    <div class="text-[10px] text-emerald-600 uppercase font-bold">Poin</div>
                    <div id="result-points" class="font-mono font-bold text-lg text-emerald-600">+100</div>
                </div>
            </div>
            <button id="result-btn" onclick="nextLevel()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">Lanjut Level Berikutnya</button>
        </div>
    </div>

    <!-- LEADERBOARD MODAL -->
    <div id="leaderboard-modal" class="hidden fixed inset-0 z-[2500] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white"><i class="fa-solid fa-trophy text-yellow-300 mr-2"></i> Papan Peringkat</h2>
                <div class="text-white text-right">
                    <p class="text-xs opacity-75 uppercase font-bold">Skor Anda</p>
                    <p id="leaderboard-my-score" class="text-2xl font-bold">0</p>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <p id="submission-status" class="text-center text-sm font-semibold text-gray-500 animate-pulse">Mengirim data ke server...</p>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-0">
                <table class="w-full leaderboard-table">
                    <thead>
                        <tr>
                            <th class="w-16 text-center">#</th>
                            <th>Nama</th>
                            <th>Sekolah</th>
                            <th class="hidden sm:table-cell">Provinsi</th>
                            <th class="text-right">Skor</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Data injected via JS -->
                    </tbody>
                </table>
            </div>

            <div class="p-4 bg-white border-t border-gray-200 text-center">
                <button onclick="location.reload()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition transform hover:scale-105">
                    <i class="fa-solid fa-rotate-right mr-2"></i> Main Lagi
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- GAME SCRIPT -->
    <script>
        /**
         * KONFIGURASI LEADERBOARD
         * URL Web App Google Apps Script
         * GANTI DENGAN URL APPS SCRIPT ANDA SETELAH DEPLOY
         */
        const LEADERBOARD_API_URL = "https://script.google.com/macros/s/AKfycbxrH9hJK9dEt77kXk6hW6lO5ocnJ4vZn9bdlz7F-QFW2f3m6Q6mOaOww5D3bAplRXrM/exec";

        // --- GAME STATE & VARIABLES ---
        let map;
        let markersClusterGroup;
        let quizMarkers = [];
        let polylines = [];
        
        let gameState = {
            phase: 'tutorial', 
            level: 1, 
            score: 0,
            explorationCount: 0,
            visitedExplorationIds: new Set(),
            currentQuizIndex: 0
        };

        window.playerProfile = {
            name: '',
            school: '',
            province: ''
        };

        // --- DATABASE --- 
        const realSpeciesDatabase = [
            // SUMATERA & SEKITARNYA (Asiatis)
            { 
                name: "Harimau Sumatera", sc: "Panthera tigris sumatrae", type: "fauna", region: "Sumatera", 
                desc: "Predator puncak yang kritis terancam punah. Hanya tersisa di Pulau Sumatera.", 
                lat: -0.5, lng: 101.5,
                traits: "<ul><li>Tubuh paling kecil di antara semua subspesies harimau.</li><li>Loreng hitam lebih rapat dan tebal.</li><li>Janggut atau surai di pipi terlihat jelas.</li><li>Selaput di sela jari kaki untuk berenang cepat.</li></ul>"
            },
            { 
                name: "Gajah Sumatera", sc: "Elephas maximus sumatranus", type: "fauna", region: "Sumatera", 
                desc: "Gajah Asia yang berhabitat di hutan dataran rendah Sumatera.", 
                lat: -4.5, lng: 105.2,
                traits: "<ul><li>Tubuh lebih kecil dari gajah Afrika.</li><li>Memiliki 5 kuku di kaki depan dan 4 di kaki belakang.</li><li>Hanya gajah jantan yang memiliki gading panjang.</li><li>Belalai fleksibel dengan satu 'jari' di ujungnya.</li></ul>"
            },
            { 
                name: "Badak Sumatera", sc: "Dicerorhinus sumatrensis", type: "fauna", region: "Sumatera", 
                desc: "Badak terkecil di dunia dan satu-satunya badak Asia bercula dua.", 
                lat: -2.5, lng: 102.5,
                traits: "<ul><li>Satu-satunya badak Asia dengan dua cula.</li><li>Tubuh ditutupi rambut kasar kemerahan.</li><li>Ukuran tubuh paling kecil dibanding spesies badak lain.</li><li>Hidup soliter di hutan hujan lebat.</li></ul>"
            },
            { 
                name: "Orangutan Sumatera", sc: "Pongo abelii", type: "fauna", region: "Sumatera", 
                desc: "Primata cerdas penghuni hutan Leuser.", 
                lat: 3.5, lng: 97.5,
                traits: "<ul><li>Bulu berwarna oranye kemerahan terang.</li><li>Lengan panjang dan kuat untuk bergelantungan.</li><li>Wajah jantan dewasa memiliki bantalan pipi (cheekpad) lebar.</li><li>Lebih sering berada di pohon dibanding tanah.</li></ul>"
            },
            { 
                name: "Orangutan Tapanuli", sc: "Pongo tapanuliensis", type: "fauna", region: "Sumatera", 
                desc: "Spesies orangutan terbaru yang ditemukan di Tapanuli Selatan.", 
                lat: 1.5, lng: 99.0,
                traits: "<ul><li>Bulu lebih keriting dibanding jenis lain.</li><li>Tengkorak dan rahang lebih kecil.</li><li>Panggilan suara jantan (long call) berbeda frekuensinya.</li><li>Hanya ditemukan di Ekosistem Batang Toru.</li></ul>"
            },
            { 
                name: "Rafflesia Arnoldii", sc: "Rafflesia arnoldii", type: "flora", region: "Sumatera", 
                desc: "Bunga tunggal terbesar di dunia, ikon Bengkulu.", 
                lat: -3.8, lng: 102.3,
                traits: "<ul><li>Bunga raksasa tanpa batang, daun, atau akar sejati.</li><li>Diameter bunga bisa mencapai 1 meter.</li><li>Mengeluarkan bau busuk untuk menarik lalat.</li><li>Hanya mekar selama 5-7 hari.</li></ul>"
            },
            { 
                name: "Bunga Bangkai", sc: "Amorphophallus titanum", type: "flora", region: "Sumatera", 
                desc: "Bunga majemuk tertinggi di dunia, baunya memikat serangga.", 
                lat: -0.1, lng: 100.6,
                traits: "<ul><li>Memiliki tongkol (spadix) yang menjulang tinggi.</li><li>Kelopak (spatha) berwarna merah hati.</li><li>Fase vegetatif berupa pohon batang semu, fase generatif berupa bunga.</li><li>Bau menyengat seperti daging busuk saat mekar.</li></ul>"
            },
            { 
                name: "Siamang", sc: "Symphalangus syndactylus", type: "fauna", region: "Sumatera", 
                desc: "Owa terbesar, terkenal dengan suaranya yang keras.", 
                lat: -1.0, lng: 100.5,
                traits: "<ul><li>Bulu hitam pekat di seluruh tubuh.</li><li>Memiliki kantung tenggorokan besar untuk memperkeras suara.</li><li>Jari kedua dan ketiga kaki menyatu (sindaktili).</li><li>Lengan sangat panjang, merentang hingga 1,5 meter.</li></ul>"
            },
            { name: "Tapir Asia", sc: "Tapirus indicus", type: "fauna", region: "Sumatera", desc: "Mamalia herbivora unik dengan warna hitam putih.", lat: 0.5, lng: 101.8, traits: "<ul><li>Pola warna tubuh hitam dan putih seperti memakai pelana.</li><li>Hidung mancung fleksibel mirip belalai pendek.</li><li>Bayi tapir memiliki pola bercak dan garis untuk kamuflase.</li><li>Aktif di malam hari (nokturnal).</li></ul>" },
            { name: "Kuau Raja", sc: "Argusianus argus", type: "fauna", region: "Sumatera", desc: "Burung dengan bulu ekor indah bermata banyak.", lat: 2.0, lng: 98.5, traits: "<ul><li>Bulu sayap dan ekor memiliki pola bulatan 'mata'.</li><li>Jantan memamerkan bulu untuk menarik betina (tarian kipas).</li><li>Kepala botak berwarna biru cerah.</li><li>Suara panggilan 'ku-au' yang keras bergema.</li></ul>" },
            { name: "Daun Payung", sc: "Johannesteijsmannia altifrons", type: "flora", region: "Sumatera", desc: "Palem dengan daun raksasa berbentuk berlian.", lat: 3.0, lng: 98.0, traits: "<ul><li>Daun tunggal raksasa berbentuk jajar genjang/berlian.</li><li>Panjang daun bisa mencapai 6 meter.</li><li>Sering digunakan penduduk sebagai atap gubuk.</li><li>Tumbuh di hutan hujan tropis yang lembap.</li></ul>" },

            // JAWA & BALI (Asiatis)
            { name: "Badak Jawa", sc: "Rhinoceros sondaicus", type: "fauna", region: "Jawa", desc: "Mamalia paling langka di dunia, hanya ada di Ujung Kulon.", lat: -6.75, lng: 105.35, traits: "<ul><li>Hanya memiliki satu cula kecil (betina sering tanpa cula).</li><li>Kulit abu-abu dengan lipatan menyerupai baju zirah.</li><li>Bibir atas meruncing untuk memegang daun.</li><li>Sangat pemalu dan soliter.</li></ul>" },
            { name: "Elang Jawa", sc: "Nisaetus bartelsi", type: "fauna", region: "Jawa", desc: "Burung pemangsa yang identik dengan lambang Garuda.", lat: -7.1, lng: 107.5, traits: "<ul><li>Jambul khas di kepala yang menjulang.</li><li>Warna bulu cokelat kemerahan di dada.</li><li>Sayap lebar membulat untuk manuver di hutan.</li><li>Predator puncak di ekosistem hutan Jawa.</li></ul>" },
            { name: "Owa Jawa", sc: "Hylobates moloch", type: "fauna", region: "Jawa", desc: "Primata endemik Jawa bagian barat yang setia pada pasangan.", lat: -6.8, lng: 106.5, traits: "<ul><li>Bulu abu-abu keperakan yang halus.</li><li>Wajah hitam legam dengan alis putih.</li><li>Tidak memiliki ekor.</li><li>Hidup monogami dalam keluarga kecil.</li></ul>" },
            { name: "Macan Tutul Jawa", sc: "Panthera pardus melas", type: "fauna", region: "Jawa", desc: "Kucing besar terakhir yang tersisa di Pulau Jawa.", lat: -8.0, lng: 113.0, traits: "<ul><li>Ukuran tubuh lebih kecil dibanding macan tutul lain.</li><li>Pola totol (rosette) khas di bulu kuning emas.</li><li>Ada variasi warna hitam legam (macan kumbang).</li><li>Kemampuan memanjat pohon yang sangat baik.</li></ul>" },
            { name: "Banteng Jawa", sc: "Bos javanicus", type: "fauna", region: "Jawa", desc: "Leluhur sapi Bali, hidup liar di Baluran dan Alas Purwo.", lat: -7.8, lng: 114.4, traits: "<ul><li>Jantan berwarna hitam, betina cokelat kemerahan.</li><li>Memiliki 'kaus kaki' putih di bagian bawah kaki.</li><li>Bercak putih besar (pantat) di bagian belakang.</li><li>Tanduk melengkung ke atas di kepalanya.</li></ul>" },
            { name: "Jalak Bali", sc: "Leucopsar rothschildi", type: "fauna", region: "Bali", desc: "Burung putih cantik maskot pulau Dewata.", lat: -8.15, lng: 114.55, traits: "<ul><li>Bulu putih bersih di seluruh tubuh.</li><li>Kulit biru cerah di sekitar mata tanpa bulu.</li><li>Jambul panjang yang bisa ditegakkan.</li><li>Ujung sayap dan ekor berwarna hitam.</li></ul>" },
            { name: "Pohon Kepel", sc: "Stelechocarpus burahol", type: "flora", region: "Jawa", desc: "Flora identitas DIY, buah favorit putri keraton.", lat: -7.8, lng: 110.4, traits: "<ul><li>Buah tumbuh bergerombol langsung di batang (cauliflory).</li><li>Daun muda berwarna merah muda cerah.</li><li>Buah dipercaya mengharumkan keringat.</li><li>Tajuk pohon berbentuk kerucut yang rapi.</li></ul>" },

            // KALIMANTAN (Asiatis)
            { name: "Orangutan Kalimantan", sc: "Pongo pygmaeus", type: "fauna", region: "Kalimantan", desc: "Spesies orangutan terbesar dan terbanyak populasinya.", lat: -1.5, lng: 113.5, traits: "<ul><li>Wajah lebih lebar dan gelap dibanding sepupu Sumatera.</li><li>Rambut lebih kasar dan berwarna merah gelap.</li><li>Bantalan pipi jantan melebar ke depan.</li><li>Lebih banyak menghabiskan waktu di tanah (terestrial).</li></ul>" },
            { name: "Bekantan", sc: "Nasalis larvatus", type: "fauna", region: "Kalimantan", desc: "Monyet hidung panjang penghuni hutan bakau.", lat: -3.3, lng: 114.6, traits: "<ul><li>Hidung jantan sangat besar dan menggantung.</li><li>Perut buncit karena sistem pencernaan khusus daun.</li><li>Bulu oranye kemerahan dengan punggung abu-abu.</li><li>Pandai berenang dan menyelam di sungai.</li></ul>" },
            { name: "Beruang Madu", sc: "Helarctos malayanus", type: "fauna", region: "Kalimantan", desc: "Beruang terkecil di dunia, maskot Balikpapan.", lat: -1.2, lng: 116.8, traits: "<ul><li>Tanda 'V' atau 'U' berwarna oranye di dada.</li><li>Lidah sangat panjang untuk menjilat madu/serangga.</li><li>Bulu hitam pendek dan mengilap.</li><li>Kuku panjang melengkung untuk memanjat pohon.</li></ul>" },
            { name: "Pesut Mahakam", sc: "Orcaella brevirostris", type: "fauna", region: "Kalimantan", desc: "Lumba-lumba air tawar yang langka di Sungai Mahakam.", lat: -0.5, lng: 117.0, traits: "<ul><li>Kepala bulat tumpul dengan dahi menonjol.</li><li>Sirip punggung kecil dan membulat.</li><li>Warna tubuh abu-abu kelabu.</li><li>Hidup di air tawar keruh Sungai Mahakam.</li></ul>" },
            { name: "Anggrek Hitam", sc: "Coelogyne pandurata", type: "flora", region: "Kalimantan", desc: "Anggrek eksotis dengan lidah berwarna hitam.", lat: 0.1, lng: 115.5, traits: "<ul><li>Kelopak bunga berwarna hijau muda cerah.</li><li>Bagian lidah (labellum) berwarna hitam dengan garis-garis.</li><li>Mengeluarkan aroma wangi lembut.</li><li>Mekar dalam tandan yang menjuntai.</li></ul>" },
            { name: "Kantong Semar Raksasa", sc: "Nepenthes rajah", type: "flora", region: "Kalimantan", desc: "Tumbuhan karnivora terbesar.", lat: 2.5, lng: 116.0, traits: "<ul><li>Memiliki kantong jebakan yang sangat besar.</li><li>Mampu menampung hingga 3 liter air.</li><li>Dapat menjebak tikus atau katak kecil.</li><li>Tumbuh di tanah pegunungan yang miskin hara.</li></ul>" },

            // SULAWESI (Wallacea)
            { name: "Anoa Dataran Rendah", sc: "Bubalus depressicornis", type: "fauna", region: "Sulawesi", desc: "Kerbau kerdil endemik Sulawesi.", lat: -4.0, lng: 122.0, traits: "<ul><li>Ukuran tubuh kecil seperti kambing.</li><li>Tanduk lurus meruncing ke belakang.</li><li>Kaki putih (stocking) pada bagian bawah.</li><li>Hidup soliter di hutan rawa atau dataran rendah.</li></ul>" },
            { name: "Babirusa", sc: "Babyrousa babyrussa", type: "fauna", region: "Sulawesi", desc: "Babi dengan taring melengkung menembus moncong.", lat: -0.8, lng: 121.5, traits: "<ul><li>Taring atas tumbuh menembus kulit moncong ke atas.</li><li>Tubuh hampir tidak berbulu, kulit abu-abu.</li><li>Kaki panjang dan kuat untuk berlari.</li><li>Taring jantan digunakan untuk pertarungan.</li></ul>" },
            { name: "Burung Maleo", sc: "Macrocephalon maleo", type: "fauna", region: "Sulawesi", desc: "Mengubur telurnya di pasir panas bumi.", lat: -0.5, lng: 123.5, traits: "<ul><li>Tonjolan keras (casque) hitam di kepala.</li><li>Bulu dada berwarna putih merah muda.</li><li>Tidak mengerami telur, menguburnya di pasir panas.</li><li>Anak burung bisa langsung terbang setelah menetas.</li></ul>" },
            { name: "Tarsius", sc: "Tarsius tarsier", type: "fauna", region: "Sulawesi", desc: "Primata karnivora terkecil di dunia.", lat: 1.4, lng: 125.0, traits: "<ul><li>Mata sangat besar (lebih besar dari otaknya).</li><li>Kepala dapat berputar 180 derajat.</li><li>Kaki belakang panjang untuk melompat jauh.</li><li>Aktif berburu serangga di malam hari.</li></ul>" },
            { name: "Kuskus Beruang", sc: "Ailurops ursinus", type: "fauna", region: "Sulawesi", desc: "Marsupial pendiam yang hidup di pohon.", lat: -2.5, lng: 120.5, traits: "<ul><li>Bulu tebal berwarna cokelat tua/hitam.</li><li>Ekor prehensil (bisa menggenggam) tanpa bulu di ujung.</li><li>Gerakan sangat lambat di atas pohon.</li><li>Memiliki kantung perut (marsupial).</li></ul>" },
            { name: "Monyet Hitam Sulawesi", sc: "Macaca nigra", type: "fauna", region: "Sulawesi", desc: "Yaki, monyet berjambul khas Sulawesi Utara.", lat: 1.6, lng: 125.1, traits: "<ul><li>Seluruh tubuh dan wajah berwarna hitam pekat.</li><li>Jambul rambut panjang di atas kepala.</li><li>Bantalan pantat berwarna merah muda cerah.</li><li>Ekor sangat pendek (hampir tidak terlihat).</li></ul>" },

            // NUSA TENGGARA (Wallacea)
            { 
                name: "Komodo", sc: "Varanus komodoensis", type: "fauna", region: "Nusa Tenggara", 
                desc: "Kadal purba terbesar di dunia.", 
                lat: -8.6, lng: 119.5,
                traits: "<ul><li>Memiliki tubuh besar dengan panjang bisa mencapai 2â€“3 meter.</li><li>Kulit bersisik kasar berwarna cokelat keabu-abuan.</li><li>Lidah panjang bercabang seperti ular dan sering menjilati udara.</li><li>Gigi tajam dan air liurnya mengandung banyak bakteri.</li><li>Berlari cepat dan mampu menyerang mangsa dengan gigitan kuat.</li></ul>"
            },
            { name: "Kuda Sumba", sc: "Equus caballus", type: "fauna", region: "Nusa Tenggara", desc: "Kuda poni tangguh dari padang savana Sumba.", lat: -9.7, lng: 120.0, traits: "<ul><li>Tubuh relatif kecil namun berotot dan kuat.</li><li>Tahan panas dan mampu menempuh jarak jauh.</li><li>Leher tebal dengan surai lebat.</li><li>Hidup liar di padang savana.</li></ul>" },
            { name: "Penyu Hijau", sc: "Chelonia mydas", type: "fauna", region: "Nusa Tenggara", desc: "Sering bertelur di pantai selatan Lombok/Sumbawa.", lat: -8.8, lng: 117.0, traits: "<ul><li>Cangkang (karapas) halus berbentuk hati.</li><li>Lemak tubuh berwarna hijau (asal namanya).</li><li>Kepala kecil dan tumpul.</li><li>Pemakan lamun dan alga (herbivora).</li></ul>" },
            { name: "Rusa Timor", sc: "Rusa timorensis", type: "fauna", region: "Nusa Tenggara", desc: "Mangsa utama Komodo.", lat: -8.5, lng: 119.4, traits: "<ul><li>Ukuran tubuh lebih kecil dari Rusa Sambar.</li><li>Jantan memiliki tanduk bercabang tiga.</li><li>Bulu cokelat kasar, leher bergelambir.</li><li>Hidup berkelompok di padang rumput terbuka.</li></ul>" },
            { name: "Flores Hawk-Eagle", sc: "Nisaetus floris", type: "fauna", region: "Nusa Tenggara", desc: "Elang endemik Flores yang terancam punah.", lat: -8.6, lng: 121.0, traits: "<ul><li>Bagian bawah tubuh putih bersih.</li><li>Kepala cokelat dengan jambul tipis.</li><li>Sayap lebar untuk soaring (melayang).</li><li>Endemik asli pulau Flores, Sumbawa, Lombok.</li></ul>" },
            { name: "Pohon Cendana", sc: "Santalum album", type: "flora", region: "Nusa Tenggara", desc: "Kayu wangi legendaris dari NTT.", lat: -9.5, lng: 124.2, traits: "<ul><li>Kayu teras mengandung minyak atsiri harum.</li><li>Daun kecil berbentuk elips saling berhadapan.</li><li>Tumbuhan parasit yang mengambil nutrisi inang.</li><li>Batang abu-abu kecokelatan.</li></ul>" },
            { name: "Lontar", sc: "Borassus flabellifer", type: "flora", region: "Nusa Tenggara", desc: "Pohon kehidupan masyarakat NTT/Sulsel.", lat: -10.2, lng: 123.6, traits: "<ul><li>Batang tunggal lurus tinggi dan kokoh.</li><li>Daun berbentuk kipas besar dengan tangkai berduri.</li><li>Menghasilkan nira manis dari mayang bunga.</li><li>Tahan kekeringan ekstrem.</li></ul>" },

            // MALUKU (Wallacea/Australis Transition)
            { name: "Burung Bidadari", sc: "Semioptera wallacii", type: "fauna", region: "Maluku", desc: "Cendrawasih endemik Halmahera, ditemukan oleh Wallace.", lat: 1.0, lng: 127.5, traits: "<ul><li>Jantan memiliki dua pasang bulu putih panjang di bahu.</li><li>Dada berwarna hijau zamrud berkilau.</li><li>Melakukan tarian udara untuk memikat betina.</li><li>Endemik pulau Halmahera dan Bacan.</li></ul>" },
            { name: "Nuri Raja Ambon", sc: "Alisterus amboinensis", type: "fauna", region: "Maluku", desc: "Burung paruh bengkok berwarna cerah.", lat: -3.7, lng: 128.2, traits: "<ul><li>Kepala dan dada merah menyala.</li><li>Sayap dan punggung hijau gelap.</li><li>Ekor panjang berwarna biru keunguan.</li><li>Suara pekikan yang tajam.</li></ul>" },
            { name: "Kuskus Tutul", sc: "Spilocuscus maculatus", type: "fauna", region: "Maluku", desc: "Marsupial dengan bulu bermotif tutul.", lat: -3.0, lng: 128.0, traits: "<ul><li>Bulu putih dengan tutul-tutul cokelat/hitam (jantan).</li><li>Mata merah atau oranye mencolok.</li><li>Wajah bulat dengan telinga kecil.</li><li>Pemakan buah dan daun di tajuk pohon.</li></ul>" },
            { name: "Pala", sc: "Myristica fragrans", type: "flora", region: "Maluku", desc: "Rempah asli Kepulauan Banda yang mendunia.", lat: -4.5, lng: 129.9, traits: "<ul><li>Buah kuning merekah memperlihatkan biji.</li><li>Biji diselimuti selaput merah (fuli).</li><li>Daun hijau gelap mengilap dan aromatik.</li><li>Tanaman berumah dua (jantan/betina terpisah).</li></ul>" },
            { name: "Cengkeh", sc: "Syzygium aromaticum", type: "flora", region: "Maluku", desc: "Tanaman rempah asli Maluku Utara.", lat: 0.8, lng: 127.4, traits: "<ul><li>Kuncup bunga kering berbau aromatik kuat.</li><li>Daun muda berwarna kemerahan.</li><li>Pohon rimbun berbentuk kerucut.</li><li>Bunga berwarna merah muda sebelum kering.</li></ul>" },

            // PAPUA (Australis)
            { name: "Cendrawasih Botak", sc: "Cicinnurus respublica", type: "fauna", region: "Papua", desc: "Burung surga cantik dari Raja Ampat.", lat: -0.5, lng: 130.8, traits: "<ul><li>Kepala botak dengan kulit berwarna biru cerah.</li><li>Pola salib hitam di atas punggung merah.</li><li>Dua bulu ekor melengkung spiral.</li><li>Hanya ditemukan di Waigeo dan Batanta.</li></ul>" },
            { name: "Cendrawasih Merah", sc: "Paradisaea rubra", type: "fauna", region: "Papua", desc: "Cendrawasih berekor kawat melengkung.", lat: -0.8, lng: 131.0, traits: "<ul><li>Bulu samping tubuh merah darah dan panjang.</li><li>Memiliki sepasang kawat ekor hitam melengkung.</li><li>Wajah hijau zamrud gelap.</li><li>Melakukan tarian di dahan pohon.</li></ul>" },
            { name: "Kakatua Raja", sc: "Probosciger aterrimus", type: "fauna", region: "Papua", desc: "Kakatua hitam terbesar dengan jambul megah.", lat: -6.0, lng: 138.0, traits: "<ul><li>Bulu hitam pekat di seluruh tubuh.</li><li>Pipi merah tanpa bulu yang bisa berubah warna.</li><li>Jambul besar seperti mahkota kipas.</li><li>Paruh sangat besar dan kuat untuk memecah biji kenari.</li></ul>" },
            { name: "Kasuari Gelambir Ganda", sc: "Casuarius casuarius", type: "fauna", region: "Papua", desc: "Burung besar tak bisa terbang, berbahaya.", lat: -5.0, lng: 139.0, traits: "<ul><li>Burung setinggi manusia yang tidak bisa terbang.</li><li>Memiliki 'helm' (casque) keras di kepala.</li><li>Leher biru dengan dua gelambir merah.</li><li>Cakar kaki tajam seperti pisau belati.</li></ul>" },
            { name: "Kanguru Pohon Mantel Emas", sc: "Dendrolagus pulcherrimus", type: "fauna", region: "Papua", desc: "Mamalia berkantung yang hidup di pohon.", lat: -2.8, lng: 136.5, traits: "<ul><li>Bulu cokelat dengan leher/bahu keemasan.</li><li>Ekor panjang untuk keseimbangan di pohon.</li><li>Lengan kuat untuk memanjat.</li><li>Wajah pucat merah muda.</li></ul>" },
            { name: "Echidna Moncong Panjang", sc: "Zaglossus", type: "fauna", region: "Papua", desc: "Mamalia bertelur (monotremata) purba.", lat: -3.5, lng: 136.0, traits: "<ul><li>Tubuh berduri seperti landak.</li><li>Moncong panjang melengkung ke bawah.</li><li>Memiliki kantung untuk mengerami telur.</li><li>Pemakan cacing tanah.</li></ul>" },
            { name: "Matoa", sc: "Pometia pinnata", type: "flora", region: "Papua", desc: "Buah manis khas Papua, mirip kelengkeng.", lat: -2.6, lng: 140.6, traits: "<ul><li>Kulit buah keras berwarna hijau/merah/hitam.</li><li>Daging buah bening, manis, beraroma durian.</li><li>Pohon besar berakar banir tinggi.</li><li>Daun majemuk menyirip ganjil.</li></ul>" }
        ];

        // Generate markers for Level 1 (Flora/Fauna Mix) and Level 2 (Fauna Focus)
        function generateGameData() {
            let data = [...realSpeciesDatabase]; 
            
            // Add slight variations to reach 150 markers
            let needed = 150 - data.length;
            for (let i = 0; i < needed; i++) {
                let template = realSpeciesDatabase[Math.floor(Math.random() * realSpeciesDatabase.length)];
                let latOffset = (Math.random() - 0.5) * 0.8;
                let lngOffset = (Math.random() - 0.5) * 0.8;
                
                data.push({
                    name: template.name,
                    sc: template.sc,
                    type: template.type,
                    region: template.region,
                    desc: template.desc,
                    lat: template.lat + latOffset,
                    lng: template.lng + lngOffset,
                    traits: template.traits,
                    isClone: true
                });
            }
            
            return data.map((d, index) => ({ ...d, id: `spec_${index}` }));
        }

        const fullData = generateGameData();
        
        // Setup Quiz Data
        const quizData = realSpeciesDatabase
            .filter(s => s.type === 'fauna')
            .sort(() => 0.5 - Math.random()) 
            .slice(0, 10)
            .map(s => {
                let z = getZoneFromLong(s.lng);
                return {
                    ...s,
                    zone: z,
                    hint: `Habitat spesies ini ada di pulau ${s.region}.`
                };
            });

        function getZoneFromLong(lng) {
            if(lng < 117) return "Asiatis";
            if(lng < 129) return "Wallacea";
            return "Australis";
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupEventListeners();
        });

        function initMap() {
            map = L.map('map', {
                center: [-2.5, 118],
                zoom: 5,
                zoomControl: false,
                minZoom: 4,
                maxBounds: [[10, 90], [-15, 145]]
            });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);

            // Draw Lines
            const wallace = L.polyline([[4.5, 118.5], [0.5, 118.5], [-1.5, 117.5], [-8.5, 115.5], [-11.0, 116.0]], { color: '#ef4444', dashArray: '10,10', weight: 2 }).addTo(map);
            wallace.bindTooltip("Garis Wallace", {permanent: true, direction: "right", className: "bg-transparent border-0 text-red-600 font-bold"});
            
            const weber = L.polyline([[2.5, 129.5], [-3.5, 126.5], [-5.5, 128.5], [-8.5, 131.5]], { color: '#3b82f6', dashArray: '10,10', weight: 2 }).addTo(map);
            weber.bindTooltip("Garis Weber", {permanent: true, direction: "right", className: "bg-transparent border-0 text-blue-600 font-bold"});
            
            polylines.push(wallace, weber);
            
            map.on('click', handleMapClick);
        }

        function setupEventListeners() {
            // Login form submit
            document.getElementById('login-form').addEventListener('submit', handleLoginSubmit);
        }

        async function handleLoginSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('input-name').value;
            const school = document.getElementById('input-school').value;
            const province = document.getElementById('input-province').value;

            if (name && school && province) {
                // UPDATE GLOBAL STATE
                window.playerProfile = { name, school, province };
                
                document.getElementById('player-name-display').innerText = name;
                document.getElementById('login-modal').classList.add('hidden');
                
                // Show Level 1 Tutorial
                showTutorialForLevel(1);
            }
        }

        function toggleMapLayers() {
            const hasLayer = map.hasLayer(polylines[0]);
            polylines.forEach(p => hasLayer ? map.removeLayer(p) : map.addLayer(p));
        }

        // --- TUTORIAL LOGIC & DATA ---
        
        // Tutorial Level 1
        const level1Slides = [
            {
                title: "Selamat Datang Explorer!",
                content: `<p class="mb-2">Misi Anda adalah menjelajahi kekayaan hayati Indonesia dalam 3 Tahap.</p>
                         <ul class="list-disc pl-5 text-sm space-y-2 mb-4 text-gray-600">
                            <li><b>Level 1:</b> Eksplorasi Umum (20 Spesies).</li>
                            <li><b>Level 2:</b> Pendalaman Zona Biogeografi (20 Fauna).</li>
                            <li><b>Level 3:</b> Kuis Tebak Lokasi.</li>
                         </ul>`
            },
            {
                title: "Navigasi Peta",
                content: `<p class="mb-3">Gunakan tombol <b>Filter</b> di level 1 untuk memilih Flora atau Fauna.</p>
                          <p class="text-sm">Titik yang berdekatan akan mengelompok (Cluster). Klik cluster untuk memperbesar.</p>`
            },
            {
                title: "Mulai Level 1",
                content: `<p>Setiap temuan baru memberi poin. Pelajari ciri-ciri hewan di Level 2 nanti karena akan berguna saat Kuis!</p>
                          <p class="mt-4 text-center font-bold text-emerald-600">Siap?</p>`
            }
        ];

        // Tutorial Level 2
        const level2Slides = [
            {
                title: "Level 2: Zona Biogeografi",
                content: `<p class="mb-2">Selamat! Anda lulus tahap dasar. Sekarang masuk ke tahap pendalaman.</p>
                          <p class="text-sm text-gray-600">Fokus kita sekarang adalah <b>3 Zona Biogeografi</b>: Asiatis, Wallacea, dan Australis.</p>`
            },
            {
                title: "Misi Baru",
                content: `<ul class="list-disc pl-5 text-sm space-y-2 mb-4 text-gray-600">
                            <li>Jelajahi kembali peta untuk menemukan <b>20 Fauna</b>.</li>
                            <li><b>PENTING:</b> Klik hewan untuk membaca <b>Ciri Khas Fisik</b> mereka.</li>
                            <li>Perhatikan detail seperti bentuk tubuh, warna, dan kebiasaan unik hewan tersebut!</li>
                         </ul>`
            }
        ];

        // Tutorial Level 3
        const level3Slides = [
            {
                title: "Level 3: Kuis Tebak Lokasi",
                content: `<p class="mb-2">Ini adalah ujian sesungguhnya bagi seorang BioExplorer.</p>
                          <p class="text-sm text-gray-600">Anda akan diberikan nama hewan dan deskripsi, tugas Anda adalah menunjuk lokasi aslinya di peta.</p>`
            },
            {
                title: "Sistem Skor",
                content: `<p class="mb-2">Akurasi adalah segalanya.</p>
                          <ul class="list-disc pl-5 text-sm space-y-1 mb-4 text-gray-600">
                            <li><b>< 50 km:</b> 100 Poin (Sempurna)</li>
                            <li><b>< 200 km:</b> 80 Poin</li>
                            <li><b>Salah Zona:</b> Poin rendah!</li>
                         </ul>
                         <p class="font-bold text-emerald-600 text-center mt-4">Buktikan pengetahuanmu!</p>`
            }
        ];

        let currentSlides = [];
        let nextLevelCallback = null;

        window.showTutorialForLevel = function(level) {
            document.getElementById('tutorial-modal').classList.remove('hidden');
            
            if (level === 1) {
                currentSlides = level1Slides;
                nextLevelCallback = startExplorationPhase;
            } else if (level === 2) {
                currentSlides = level2Slides;
                nextLevelCallback = startZoneExplorationPhase;
            } else if (level === 3) {
                currentSlides = level3Slides;
                nextLevelCallback = startQuizPhase;
            }
            
            renderTutorial(0);
        }

        function renderTutorial(index) {
            document.getElementById('tut-title').innerText = currentSlides[index].title;
            document.getElementById('tutorial-content').innerHTML = currentSlides[index].content;
            
            const dots = document.getElementById('tutorial-dots');
            dots.innerHTML = currentSlides.map((_, i) => `<div class="h-2 rounded-full transition-all ${i === index ? 'w-6 bg-emerald-500' : 'w-2 bg-gray-300'}"></div>`).join('');
            
            const btn = document.getElementById('tutorial-btn');
            if (index < currentSlides.length - 1) {
                btn.innerText = "Lanjut";
                btn.onclick = () => renderTutorial(index + 1);
            } else {
                btn.innerText = "Mulai";
                btn.onclick = () => {
                    document.getElementById('tutorial-modal').classList.add('hidden');
                    if (nextLevelCallback) nextLevelCallback();
                };
            }
        }

        // --- LEVEL 1: GENERAL EXPLORATION ---
        function startExplorationPhase() {
            gameState.phase = 'exploration';
            gameState.level = 1;
            
            // HUD
            document.getElementById('game-hud').classList.remove('hidden');
            document.getElementById('exploration-controls').classList.remove('hidden');
            document.getElementById('level1-filters').classList.remove('hidden');
            document.getElementById('level2-indicator').classList.add('hidden');
            
            document.getElementById('level-display').innerText = "1: Eksplorasi Umum";
            updateScoreDisplays();
            updateExplorationUI();

            setupMarkersLevel1();
        }

        function setupMarkersLevel1() {
            if (markersClusterGroup) map.removeLayer(markersClusterGroup);

            markersClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 40,
                iconCreateFunction: function(cluster) {
                    return L.divIcon({ 
                        html: '<div class="w-10 h-10 bg-emerald-600 rounded-full text-white flex items-center justify-center font-bold border-2 border-white shadow-lg">' + cluster.getChildCount() + '</div>', 
                        className: 'bg-transparent', 
                        iconSize: L.point(40, 40) 
                    });
                }
            });
            map.addLayer(markersClusterGroup);
            filterMarkers('all');
        }

        window.filterMarkers = function(type) {
            markersClusterGroup.clearLayers();
            
            // UI States
            ['btn-all', 'btn-flora', 'btn-fauna'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('active', 'bg-emerald-600', 'text-white', 'border-emerald-600');
                el.classList.add('text-gray-600', 'border-gray-300');
            });
            const activeId = `btn-${type}`;
            const activeEl = document.getElementById(activeId);
            activeEl.classList.add('active', 'bg-emerald-600', 'text-white', 'border-emerald-600');
            activeEl.classList.remove('text-gray-600', 'border-gray-300');

            const filteredData = type === 'all' ? fullData : fullData.filter(d => d.type === type);

            filteredData.forEach(item => {
                const marker = createMarker(item, false); // Level 1 mode
                markersClusterGroup.addLayer(marker);
            });
        }

        // Helper to create marker (Shared logic but content differs by Level)
        function createMarker(item, isLevel2) {
            const isFlora = item.type === 'flora';
            const colorClass = isFlora ? 'text-green-600' : 'text-orange-600';
            const iconClass = isFlora ? 'fa-seedling' : 'fa-paw';
            
            const customIcon = L.divIcon({
                className: 'bg-transparent',
                html: `
                    <div class="relative group">
                        <div class="w-8 h-8 bg-white rounded-full shadow-md border border-gray-200 flex items-center justify-center ${colorClass} text-sm hover:scale-125 transition-transform duration-300 cursor-pointer">
                            <i class="fa-solid ${iconClass}"></i>
                        </div>
                    </div>
                `,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const marker = L.marker([item.lat, item.lng], { icon: customIcon });

            // GENERATE CONTENT BASED ON LEVEL
            let descriptionHTML = "";
            const zone = getZoneFromLong(item.lng);
            
            if (isLevel2) {
                // LEVEL 2: Show SPECIFIC ANIMAL TRAITS
                const animalTraits = item.traits || "<ul><li>Spesies unik endemik Indonesia.</li><li>Memiliki adaptasi khusus di habitatnya.</li></ul>";
                
                descriptionHTML = `
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200 mb-2">
                        <div class="flex items-center justify-between mb-1">
                             <p class="text-xs font-bold text-purple-700 uppercase"><i class="fa-solid fa-paw mr-1"></i> Ciri Khas Spesies</p>
                        </div>
                        <div class="text-sm text-purple-900 leading-snug font-medium pl-4 list-disc space-y-1">
                            ${animalTraits}
                        </div>
                    </div>
                `;
            } else {
                // LEVEL 1: Show General Description
                descriptionHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded bg-gray-100 text-gray-500">${item.region}</span>
                        <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded ${item.type === 'flora' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">${item.type}</span>
                    </div>
                    <p class="text-sm text-gray-700 leading-snug mb-2">${item.desc}</p>
                `;
            }

            const popupHTML = `
                <div class="font-sans">
                    <div class="bg-gradient-to-r ${isFlora ? 'from-green-500 to-emerald-600' : 'from-orange-500 to-red-500'} p-3 text-white">
                        <div class="flex items-center justify-between">
                            <h3 class="font-bold text-lg leading-tight">${item.name}</h3>
                            ${isLevel2 ? `<span class="ml-2 text-[10px] bg-white/20 px-1 rounded text-white border border-white/30">${zone}</span>` : ''}
                        </div>
                        <p class="text-xs italic opacity-90">${item.sc}</p>
                    </div>
                    <div class="p-3 bg-white">
                        ${descriptionHTML}
                        
                        ${!gameState.visitedExplorationIds.has(item.id + (isLevel2 ? '_L2' : '')) ? 
                            `<div class="mt-2 text-center text-xs font-bold text-emerald-600 animate-pulse bg-emerald-50 py-1 rounded">
                                <i class="fa-solid fa-plus-circle"></i> +10 Poin Baru!
                             </div>` : 
                            `<div class="mt-2 text-center text-xs font-bold text-gray-400 bg-gray-50 py-1 rounded">
                                <i class="fa-solid fa-check"></i> Sudah Dibaca
                             </div>`
                        }
                    </div>
                </div>
            `;
            
            marker.bindPopup(popupHTML);
            
            marker.on('popupopen', () => {
                const trackingId = item.id + (isLevel2 ? '_L2' : '');
                
                if (!gameState.visitedExplorationIds.has(trackingId)) {
                    gameState.visitedExplorationIds.add(trackingId);
                    gameState.explorationCount++;
                    gameState.score += 10;
                    
                    updateScoreDisplays();
                    updateExplorationUI();
                    
                    setTimeout(() => marker.setPopupContent(popupHTML.replace('+10 Poin Baru!', 'Sudah Dibaca').replace('text-emerald-600', 'text-gray-400').replace('bg-emerald-50', 'bg-gray-50')), 500);
                }
            });

            return marker;
        }

        function updateExplorationUI() {
            document.getElementById('explore-count').innerText = `${gameState.explorationCount}/20`;
            const pct = Math.min((gameState.explorationCount / 20) * 100, 100);
            document.getElementById('progress-bar').style.width = `${pct}%`;
            
            const finishBtn = document.getElementById('btn-finish-explore');
            if (gameState.explorationCount >= 20) {
                finishBtn.disabled = false;
                finishBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                finishBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-lg', 'transform', 'hover:scale-105');
                
                if (gameState.level === 1) {
                    finishBtn.innerHTML = `Lanjut Level 2 <i class="fa-solid fa-arrow-right ml-1"></i>`;
                } else {
                    finishBtn.innerHTML = `Lanjut Kuis <i class="fa-solid fa-flag-checkered ml-1"></i>`;
                }
            } else {
                finishBtn.disabled = true;
                finishBtn.innerHTML = `Lanjut <i class="fa-solid fa-lock ml-1"></i>`;
                finishBtn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                finishBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            }
        }

        function updateScoreDisplays() {
            document.getElementById('score-display').innerText = gameState.score;
            document.getElementById('score-display-mobile').innerText = gameState.score;
        }

        window.finishExploration = function() {
            if (gameState.level === 1) {
                window.showTutorialForLevel(2);
            } else if (gameState.level === 2) {
                finishZoneExploration();
            }
        }

        // --- LEVEL 2: ZONE EXPLORATION ---
        function startZoneExplorationPhase() {
            gameState.level = 2;
            gameState.explorationCount = 0; 
            
            document.getElementById('level-display').innerText = "2: Zona Biogeografi";
            document.getElementById('level1-filters').classList.add('hidden');
            document.getElementById('level2-indicator').classList.remove('hidden');
            
            setupMarkersLevel2();
            updateExplorationUI(); 
        }

        function setupMarkersLevel2() {
            if (markersClusterGroup) map.removeLayer(markersClusterGroup);

            markersClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 45,
                iconCreateFunction: function(cluster) {
                    return L.divIcon({ 
                        html: '<div class="w-10 h-10 bg-purple-600 rounded-full text-white flex items-center justify-center font-bold border-2 border-white shadow-lg">' + cluster.getChildCount() + '</div>', 
                        className: 'bg-transparent', 
                        iconSize: L.point(40, 40) 
                    });
                }
            });
            map.addLayer(markersClusterGroup);

            const faunaData = fullData.filter(d => d.type === 'fauna');
            faunaData.forEach(item => {
                const marker = createMarker(item, true); 
                markersClusterGroup.addLayer(marker);
            });
        }

        function finishZoneExploration() {
            map.removeLayer(markersClusterGroup);
            const controls = document.getElementById('exploration-controls');
            controls.style.opacity = '0';
            setTimeout(() => {
                controls.classList.add('hidden');
                window.showTutorialForLevel(3);
            }, 300);
        }

        // --- LEVEL 3: QUIZ ---
        function startQuizPhase() {
            gameState.phase = 'quiz';
            gameState.level = 3;
            document.getElementById('level-display').innerText = "3: Kuis Lokasi";
            document.getElementById('clue-card').classList.remove('hidden');
            document.getElementById('quiz-hud-info').classList.remove('hidden');
            loadQuizLevel();
        }

        function loadQuizLevel() {
            if (gameState.currentQuizIndex >= quizData.length) {
                endGame();
                return;
            }
            quizMarkers.forEach(m => map.removeLayer(m));
            quizMarkers = [];
            document.getElementById('hint-text').classList.add('hidden');

            const currentSpecies = quizData[gameState.currentQuizIndex];
            document.getElementById('species-quiz-name').innerText = currentSpecies.name;
            document.getElementById('species-quiz-scientific').innerText = currentSpecies.sc;
            document.getElementById('species-quiz-desc').innerText = currentSpecies.desc;
            document.getElementById('zone-display-hud').innerText = currentSpecies.zone;
            document.getElementById('hint-text').innerText = currentSpecies.hint;
            document.getElementById('quiz-progress-badge').innerText = `${gameState.currentQuizIndex + 1}/${quizData.length}`;

            map.flyTo([-2.5, 118], 5, {duration: 1.0});
        }

        window.showHint = function() {
            document.getElementById('hint-text').classList.remove('hidden');
            gameState.score = Math.max(0, gameState.score - 5);
            updateScoreDisplays();
        }

        function handleMapClick(e) {
            if (gameState.phase !== 'quiz') return;
            if (!document.getElementById('result-modal').classList.contains('hidden')) return;

            const currentSpecies = quizData[gameState.currentQuizIndex];
            const targetLatLng = L.latLng(currentSpecies.lat, currentSpecies.lng);
            const distanceKm = (targetLatLng.distanceTo(e.latlng) / 1000).toFixed(0);

            const guessMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'bg-transparent', html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg pulse-marker"></div>' }) }).addTo(map);
            const targetMarker = L.marker(targetLatLng, { icon: L.divIcon({ className: 'bg-transparent', html: `<div class="text-3xl text-red-600 drop-shadow-md"><i class="fa-solid fa-location-dot"></i></div>` }) }).addTo(map);
            const line = L.polyline([e.latlng, targetLatLng], { color: 'gray', dashArray: '5, 10' }).addTo(map);
            
            quizMarkers.push(guessMarker, targetMarker, line);
            map.fitBounds(L.latLngBounds(e.latlng, targetLatLng), {padding: [50, 50], maxZoom: 8});

            let points = 0;
            if (distanceKm < 50) points = 100;
            else if (distanceKm < 200) points = 80;
            else if (distanceKm < 500) points = 50;
            else if (distanceKm < 1000) points = 20;
            else points = 10;

            gameState.score += points;
            updateScoreDisplays();

            setTimeout(() => {
                showResultModal(points, distanceKm);
            }, 1200);
        }

        function showResultModal(points, km) {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            
            modal.classList.remove('hidden');
            document.getElementById('result-distance').innerText = km + ' km';
            document.getElementById('result-points').innerText = '+' + points;

            if (points >= 80) {
                document.getElementById('result-title').innerText = "Sempurna!";
                document.getElementById('result-message').innerText = "Insting biologi Anda tajam sekali!";
                icon.innerHTML = '<i class="fa-solid fa-star text-emerald-500"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-emerald-100";
            } else if (points >= 50) {
                document.getElementById('result-title').innerText = "Bagus!";
                document.getElementById('result-message').innerText = "Tebakan yang cukup dekat.";
                icon.innerHTML = '<i class="fa-solid fa-thumbs-up text-blue-500"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-blue-100";
            } else {
                document.getElementById('result-title').innerText = "Terlalu Jauh";
                document.getElementById('result-message').innerText = "Coba perhatikan peta zonasi lagi.";
                icon.innerHTML = '<i class="fa-solid fa-map-location-dot text-orange-500"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-orange-100";
            }
        }

        window.nextLevel = function() {
            document.getElementById('result-modal').classList.add('hidden');
            gameState.currentQuizIndex++;
            loadQuizLevel();
        }

        function endGame() {
            // 1. Hide Game UI
            document.getElementById('clue-card').classList.add('hidden');
            document.getElementById('quiz-hud-info').classList.add('hidden');
            document.getElementById('result-modal').classList.add('hidden');

            // 2. Show Final Score in Result Modal
            const modal = document.getElementById('result-modal');
            modal.classList.remove('hidden');
            
            document.getElementById('result-title').innerText = "Misi Selesai!";
            document.getElementById('result-message').innerText = `Selamat ${window.playerProfile.name}, Anda telah menyelesaikan ekspedisi.`;
            document.getElementById('result-icon').innerHTML = '<i class="fa-solid fa-trophy text-yellow-500"></i>';
            document.getElementById('result-icon').className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-yellow-100";
            
            document.getElementById('result-distance').parentElement.style.display = 'none'; 
            document.getElementById('result-points').innerText = gameState.score;
            document.querySelector('#result-points').previousElementSibling.innerText = "SKOR AKHIR";

            // 3. Change Button to "Submit & View Leaderboard"
            const btn = document.getElementById('result-btn');
            btn.innerText = "Kirim Skor & Lihat Peringkat";
            btn.className = "w-full bg-purple-600 hover:bg-purple-700 text-white py-3.5 rounded-xl font-bold shadow-lg mt-4";
            btn.onclick = submitAndShowLeaderboard;
        }

        async function submitAndShowLeaderboard() {
            // Close result modal, open leaderboard modal
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('leaderboard-modal').classList.remove('hidden');
            document.getElementById('leaderboard-my-score').innerText = gameState.score;

            // Prepare Data
            const payload = {
                nama: window.playerProfile.name,
                sekolah: window.playerProfile.school,
                provinsi: window.playerProfile.province,
                skor: gameState.score,
                action: 'submit'
            };

            const statusEl = document.getElementById('submission-status');

            // SUBMIT DATA to Google Apps Script
            try {
                if (LEADERBOARD_API_URL && LEADERBOARD_API_URL.startsWith('http')) {
                    // Send POST request
                    const formData = new URLSearchParams();
                    for (const key in payload) {
                        formData.append(key, payload[key]);
                    }

                    const response = await fetch(LEADERBOARD_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });

                    if (response.ok) {
                        statusEl.innerText = "Skor berhasil dikirim! Memuat peringkat...";
                        statusEl.className = "text-center text-sm font-semibold text-green-600";
                    } else {
                        statusEl.innerText = "Gagal mengirim skor, coba lagi...";
                        statusEl.className = "text-center text-sm font-semibold text-red-600";
                    }
                } else {
                    statusEl.innerText = "Mode Demo (API URL belum dikonfigurasi)";
                    statusEl.className = "text-center text-sm font-semibold text-yellow-600";
                }
            } catch (e) {
                console.error("Submission error", e);
                statusEl.innerText = "Gagal mengirim skor, memuat data lokal...";
                statusEl.className = "text-center text-sm font-semibold text-red-600";
            }

            // FETCH LEADERBOARD
            setTimeout(fetchLeaderboard, 1500);
        }

        async function fetchLeaderboard() {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4"><i class="fa-solid fa-spinner fa-spin text-purple-600"></i> Memuat data...</td></tr>';

            try {
                if (LEADERBOARD_API_URL && LEADERBOARD_API_URL.startsWith('http')) {
                    const response = await fetch(LEADERBOARD_API_URL);
                    const data = await response.json();
                    renderLeaderboardTable(data);
                    document.getElementById('submission-status').classList.add('hidden');
                } else {
                    // Dummy data for demo
                    const demoData = [
                        {nama: "Budi Santoso", sekolah: "SMAN 1 Jakarta", provinsi: "DKI Jakarta", skor: 2850},
                        {nama: window.playerProfile.name, sekolah: window.playerProfile.school, provinsi: window.playerProfile.province, skor: gameState.score},
                        {nama: "Siti Nurhaliza", sekolah: "SMA 3 Bandung", provinsi: "Jawa Barat", skor: 2450},
                        {nama: "Ahmad Yani", sekolah: "SMK Teknologi", provinsi: "Jawa Timur", skor: 2200},
                        {nama: "Rina Dewi", sekolah: "SMA Negeri 5", provinsi: "Bali", skor: 1950},
                        {nama: "Andi Pratama", sekolah: "SMAN 2 Makassar", provinsi: "Sulawesi Selatan", skor: 1800},
                        {nama: "Dewi Lestari", sekolah: "SMA Taruna", provinsi: "Kalimantan Timur", skor: 1650},
                        {nama: "Fajar Siddik", sekolah: "SMAN 1 Medan", provinsi: "Sumatera Utara", skor: 1500},
                        {nama: "Maya Sari", sekolah: "SMA Kristen", provinsi: "Papua", skor: 1350},
                        {nama: "Rizky Ramadhan", sekolah: "SMAN 4 Surabaya", provinsi: "Jawa Timur", skor: 1200}
                    ].sort((a,b) => b.skor - a.skor);
                    
                    renderLeaderboardTable(demoData);
                    document.getElementById('submission-status').innerText = "Mode Demo: Data contoh ditampilkan";
                    document.getElementById('submission-status').className = "text-center text-sm font-semibold text-yellow-600";
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">Gagal memuat data leaderboard. Silakan coba lagi nanti.</td></tr>';
            }
        }

        function renderLeaderboardTable(data) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            data.forEach((row, index) => {
                const rank = index + 1;
                let rankClass = "text-gray-600";
                let icon = "";
                
                if (rank === 1) { rankClass = "rank-1"; icon = '<i class="fa-solid fa-crown text-yellow-400 mr-1"></i>'; }
                else if (rank === 2) { rankClass = "rank-2"; icon = '<i class="fa-solid fa-medal text-gray-400 mr-1"></i>'; }
                else if (rank === 3) { rankClass = "rank-3"; icon = '<i class="fa-solid fa-medal text-orange-400 mr-1"></i>'; }

                const tr = document.createElement('tr');
                tr.className = (row.nama === window.playerProfile.name && row.skor == gameState.score) ? "bg-purple-50 border-l-4 border-purple-500" : "hover:bg-gray-50";
                
                tr.innerHTML = `
                    <td class="text-center ${rankClass}">${icon}${rank}</td>
                    <td class="font-bold text-gray-700">${row.nama}</td>
                    <td class="text-gray-600">${row.sekolah}</td>
                    <td class="hidden sm:table-cell text-gray-500 text-xs uppercase tracking-wide">${row.provinsi}</td>
                    <td class="text-right font-mono font-bold text-purple-700">${row.skor}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioExplorer Nusantara: Ekspedisi Endemik</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            overflow: hidden; 
        }
        
        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
        }

        /* Glassmorphism UI elements */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Filter Buttons Active State */
        .filter-btn.active {
            background-color: #059669; /* emerald-600 */
            color: white;
            border-color: #059669;
        }

        /* Leaflet Popup Custom Style */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 350px !important; 
            max-height: 500px;
            overflow-y: auto;
        }

        .input-focus-ring:focus {
            outline: none;
            ring: 2px;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
            border-color: #10B981;
        }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #10B981;
            border-radius: 10px;
        }

        /* Leaderboard Table Styles */
        .leaderboard-table th {
            background-color: #f3f4f6;
            color: #374151;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 0.75rem;
            text-align: left;
        }
        .leaderboard-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }
        .rank-1 { color: #d97706; font-weight: bold; } /* Gold */
        .rank-2 { color: #9ca3af; font-weight: bold; } /* Silver */
        .rank-3 { color: #b45309; font-weight: bold; } /* Bronze */

        /* CSS untuk Mini Quiz dan Marker */
        #mini-quiz-options button.correct {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
        }

        #mini-quiz-options button.wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
        }

        /* Animasi bounce-in untuk modal */
        @keyframes bounce-in {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .animate-bounce-in {
            animation: bounce-in 0.5s ease-out;
        }

        /* Animasi pulsing untuk marker */
        .pulse-marker {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Marker yang sudah dikunjungi - BULAT */
        .marker-visited {
            background-color: #9ca3af !important; /* Abu-abu */
            border-radius: 50% !important;
        }

        .marker-visited i {
            color: #6b7280 !important;
        }

        /* CSS tambahan untuk clue card di Level 3 */
        #clue-card.quiz-mode {
            position: absolute;
            left: 1rem;
            bottom: 1rem;
            width: 280px;
            max-width: 280px;
            transform: none;
            margin: 0;
            z-index: 1000;
        }

        #clue-card.quiz-mode .glass-panel {
            padding: 1rem !important;
            border-radius: 12px !important;
        }

        #clue-card.quiz-mode h2 {
            font-size: 1rem !important;
            margin-bottom: 0.25rem !important;
        }

        #clue-card.quiz-mode p {
            font-size: 0.75rem !important;
            line-height: 1.2 !important;
        }

        #clue-card.quiz-mode #species-quiz-desc {
            margin-bottom: 0.75rem !important;
            padding-top: 0.5rem !important;
        }

        #clue-card.quiz-mode .flex.justify-between {
            gap: 0.5rem !important;
        }

        #clue-card.quiz-mode button {
            padding: 0.4rem 0.75rem !important;
            font-size: 0.7rem !important;
        }

        /* CSS untuk gambar di popup */
        .species-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .popup-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .popup-image-container img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .popup-image-container:hover img {
            transform: scale(1.05);
        }

        .image-caption {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            font-size: 0.75rem;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10B981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error message */
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        /* Debug loading animation */
        .debug-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .debug-loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10B981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        /* Debug info styling */
        .debug-details {
            font-family: monospace;
            font-size: 0.7rem;
            line-height: 1.4;
        }
        
        .debug-details p {
            margin-bottom: 0.25rem;
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Audio Elements (Hidden) -->
    <audio id="background-music" loop preload="auto">
        <source src="https://denicendrianto41.github.io/backsound.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <audio id="coin-sound" preload="auto">
        <source src="https://denicendrianto41.github.io/koin.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    
    <audio id="visited-sound" preload="auto">
        <source src="https://denicendrianto41.github.io/gameover.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    
    <audio id="success-sound" preload="auto">
        <source src="https://denicendrianto41.github.io/berhasil.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    
    <audio id="wrong-sound" preload="auto">
        <source src="https://denicendrianto41.github.io/salah.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    
    <!-- Audio untuk Misi Selesai -->
    <audio id="mission-complete-sound" preload="auto">
        <source src="https://denicendrianto41.github.io/misi-selesai.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    
    <!-- Audio untuk Mini Quiz -->
    <audio id="mini-quiz-sound" preload="auto">
        <source src="https://denicendrianto41.github.io/tring.wav" type="audio/wav">
        Your browser does not support the audio element.
    </audio>

    <!-- MAP CONTAINER -->
    <div id="map"></div>

    <!-- UI LAYER -->
    <div class="absolute inset-0 pointer-events-none z-[1000] flex flex-col justify-between p-2 md:p-4">
        
        <!-- TOP HUD -->
        <div id="game-hud" class="hidden pointer-events-auto flex flex-col gap-2 w-full max-w-6xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 w-full">
                <!-- Player Profile -->
                <div class="glass-panel rounded-xl p-2 px-3 shadow-lg flex items-center gap-3 w-full md:w-auto">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 border-2 border-white shadow-sm">
                        <i class="fa-solid fa-user-astronaut text-lg"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Explorer</p>
                        <p id="player-name-display" class="text-blue-900 font-bold text-sm truncate">Guest</p>
                    </div>
                    <!-- Mobile Score -->
                    <div class="md:hidden text-right border-l pl-3 ml-2">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Skor</p>
                        <p id="score-display-mobile" class="text-emerald-600 font-bold text-lg leading-none">0</p>
                    </div>
                </div>

                <!-- FILTER DAN TARGET MISI (TENGAH) -->
                <div id="exploration-controls" class="hidden pointer-events-auto w-full md:w-auto transition-all duration-300">
                    <div class="glass-panel rounded-xl p-3 shadow-lg flex flex-col md:flex-row justify-between items-center gap-3">
                        <div id="level1-filters" class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                            <button onclick="filterMarkers('all')" id="btn-all" class="filter-btn active px-4 py-1.5 rounded-full border border-gray-300 text-sm font-bold text-gray-600 hover:bg-gray-100 transition whitespace-nowrap">Semua</button>
                            <button onclick="filterMarkers('flora')" id="btn-flora" class="filter-btn px-4 py-1.5 rounded-full border border-gray-300 text-sm font-bold text-gray-600 hover:bg-gray-100 transition whitespace-nowrap"><i class="fa-solid fa-seedling mr-1 text-green-500"></i> Flora</button>
                            <button onclick="filterMarkers('fauna')" id="btn-fauna" class="filter-btn px-4 py-1.5 rounded-full border border-gray-300 text-sm font-bold text-gray-600 hover:bg-gray-100 transition whitespace-nowrap"><i class="fa-solid fa-paw mr-1 text-orange-500"></i> Fauna</button>
                        </div>
                        <div id="level2-indicator" class="hidden flex gap-2 items-center">
                             <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-bold border border-purple-200 shadow-sm"><i class="fa-solid fa-layer-group mr-1"></i> Zona Biogeografi</span>
                             <span class="text-xs text-gray-500 italic hidden md:inline">Klik hewan untuk melihat ciri khasnya</span>
                        </div>
                        <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                            <div class="text-right">
                                <p class="text-[10px] text-gray-500 font-bold uppercase">Target Misi</p>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
                                    </div>
                                    <p id="explore-count" class="text-blue-700 font-bold text-sm">0/20</p>
                                </div>
                            </div>
                            <button id="btn-finish-explore" onclick="finishExploration()" disabled class="bg-gray-200 text-gray-400 px-5 py-2 rounded-lg font-bold shadow-none cursor-not-allowed transition flex items-center gap-2 text-sm">Lanjut <i class="fa-solid fa-lock"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Desktop Score -->
                <div class="hidden md:flex glass-panel rounded-xl p-2 px-6 shadow-lg items-center gap-8">
                    <div class="text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Level Saat Ini</p>
                        <p id="level-display" class="text-purple-700 font-bold text-lg">Memuat data...</p>
                    </div>
                    <div class="h-10 w-px bg-gray-300"></div>
                    <div class="text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Total Poin</p>
                        <p id="score-display" class="text-emerald-600 font-bold text-2xl leading-none">0</p>
                    </div>
                </div>
            </div>
            
            <div id="quiz-hud-info" class="hidden pointer-events-auto self-end mt-2">
                 <div class="glass-panel rounded-full px-4 py-1 shadow-md flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-500 uppercase">Zona Target:</span>
                    <span id="zone-display-hud" class="text-sm font-bold text-purple-700">...</span>
                 </div>
            </div>
        </div>

        <!-- Clue Card -->
        <div id="clue-card" class="hidden pointer-events-auto w-full max-w-md mx-auto mb-4 transition-all duration-500 transform translate-y-0">
            <div class="glass-panel rounded-2xl shadow-2xl p-5 border-l-8 border-yellow-400 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-paw text-6xl"></i></div>
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-[10px] font-bold text-yellow-600 uppercase tracking-wider mb-1 bg-yellow-100 inline-block px-2 rounded">Misi Pencarian</h3>
                        <h2 id="species-quiz-name" class="text-xl font-bold text-gray-800">???</h2>
                        <p class="text-xs text-gray-500 italic mb-2" id="species-quiz-scientific">Scientific Name</p>
                    </div>
                    <div class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded" id="quiz-progress-badge">1/10</div>
                </div>
                <div id="species-quiz-desc" class="text-sm text-gray-700 mb-4 leading-relaxed border-t pt-2 mt-1">Menunggu data misi...</div>
                <div class="flex justify-between items-center gap-2">
                    <button onclick="toggleMapLayers()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition"><i class="fa-solid fa-layer-group"></i> Peta Zona</button>
                    <button id="hint-btn" onclick="showHint()" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition text-center"><i class="fa-regular fa-lightbulb"></i> Bantuan (-5 Poin)</button>
                </div>
                <div id="hint-text" class="hidden mt-3 p-2 bg-yellow-50 text-xs text-yellow-800 rounded border border-yellow-200 animate-pulse"></div>
            </div>
        </div>
    </div>

    <!-- LOADING MODAL -->
    <div id="loading-modal" class="fixed inset-0 z-[4000] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center">
            <div class="loading-spinner mx-auto mb-6"></div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Memuat Data Spesies</h2>
            <p id="loading-message" class="text-gray-600 text-sm mb-4">Mengambil data flora dan fauna dari database...</p>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                <div id="loading-progress" class="bg-emerald-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="loading-status" class="text-xs text-gray-500">Menghubungkan ke server...</p>
            <div id="connection-test-result" class="mt-4"></div>
            <div id="api-debug-info" class="mt-4 text-left text-xs bg-gray-50 p-3 rounded hidden">
                <h4 class="font-bold mb-2">Status Koneksi:</h4>
                <div id="debug-loading" class="debug-loading">
                    <div class="spinner"></div>
                    <span>Menguji koneksi ke server...</span>
                </div>
                <div id="debug-details" class="debug-details hidden">
                    <p id="api-url-display"></p>
                    <p id="api-response-status"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="hidden fixed inset-0 z-[3000] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="bg-gradient-to-br from-emerald-600 to-teal-700 p-8 text-center relative overflow-hidden">
                <i class="fa-solid fa-leaf text-white/20 text-9xl absolute -bottom-8 -left-8 transform rotate-12"></i>
                <h1 class="text-3xl font-bold text-white relative z-10 mb-1">BioExplorer</h1>
                <p class="text-emerald-100 text-sm relative z-10 font-medium tracking-wide">EKSPEDISI FLORA & FAUNA</p>
            </div>
            <div class="p-8">
                <div id="database-status" class="mb-4 p-3 rounded-lg bg-blue-50 border border-blue-200">
                    <p class="text-sm text-blue-700 font-medium">
                        <i class="fas fa-database mr-2"></i>
                        <span id="db-status-text">Menggunakan data lokal</span>
                    </p>
                </div>
                
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Lengkap</label>
                        <div class="relative">
                            <i class="fa-solid fa-user absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="input-name" required class="input-focus-ring block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg text-gray-800 font-semibold" placeholder="Nama Siswa">
                        </div>
                    </div>
                    
                    <!-- INPUT SEKOLAH -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Sekolah</label>
                        <div class="relative">
                            <i class="fa-solid fa-school absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="input-school" required class="input-focus-ring block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg text-gray-800 font-semibold" placeholder="Nama Sekolah">
                        </div>
                    </div>

                    <!-- DROPDOWN PROVINSI -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Provinsi</label>
                        <div class="relative">
                            <i class="fa-solid fa-map-location-dot absolute left-3 top-3 text-gray-400"></i>
                            <select id="input-province" required class="input-focus-ring block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg text-gray-800 font-semibold bg-white appearance-none cursor-pointer">
                                <option value="" disabled selected>Pilih Provinsi</option>
                                <option value="Nanggroe Aceh Darussalam">Nanggroe Aceh Darussalam</option>
                                <option value="Sumatera Utara">Sumatera Utara</option>
                                <option value="Sumatera Selatan">Sumatera Selatan</option>
                                <option value="Sumatera Barat">Sumatera Barat</option>
                                <option value="Bengkulu">Bengkulu</option>
                                <option value="Riau">Riau</option>
                                <option value="Kepulauan Riau">Kepulauan Riau</option>
                                <option value="Jambi">Jambi</option>
                                <option value="Lampung">Lampung</option>
                                <option value="Bangka Belitung">Bangka Belitung</option>
                                <option value="Kalimantan Barat">Kalimantan Barat</option>
                                <option value="Kalimantan Timur">Kalimantan Timur</option>
                                <option value="Kalimantan Selatan">Kalimantan Selatan</option>
                                <option value="Kalimantan Tengah">Kalimantan Tengah</option>
                                <option value="Kalimantan Utara">Kalimantan Utara</option>
                                <option value="Banten">Banten</option>
                                <option value="DKI Jakarta">DKI Jakarta</option>
                                <option value="Jawa Barat">Jawa Barat</option>
                                <option value="Jawa Tengah">Jawa Tengah</option>
                                <option value="Daerah Istimewa Yogyakarta">Daerah Istimewa Yogyakarta</option>
                                <option value="Jawa Timur">Jawa Timur</option>
                                <option value="Bali">Bali</option>
                                <option value="Nusa Tenggara Timur">Nusa Tenggara Timur</option>
                                <option value="Nusa Tenggara Barat">Nusa Tenggara Barat</option>
                                <option value="Gorontalo">Gorontalo</option>
                                <option value="Sulawesi Barat">Sulawesi Barat</option>
                                <option value="Sulawesi Tengah">Sulawesi Tengah</option>
                                <option value="Sulawesi Utara">Sulawesi Utara</option>
                                <option value="Sulawesi Tenggara">Sulawesi Tenggara</option>
                                <option value="Sulawesi Selatan">Sulawesi Selatan</option>
                                <option value="Maluku Utara">Maluku Utara</option>
                                <option value="Maluku">Maluku</option>
                                <option value="Papua Barat">Papua Barat</option>
                                <option value="Papua">Papua</option>
                                <option value="Papua Tengah">Papua Tengah</option>
                                <option value="Papua Pegunungan">Papua Pegunungan</option>
                                <option value="Papua Selatan">Papua Selatan</option>
                                <option value="Papua Barat Daya">Papua Barat Daya</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-3.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg transform hover:translate-y-[-1px] transition-all">
                        Mulai Petualangan
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- TUTORIAL MODAL -->
    <div id="tutorial-modal" class="hidden fixed inset-0 z-[2000] bg-black/70 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh]">
            <div class="h-40 bg-cover bg-center flex items-end relative" style="background-image: url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?q=80&w=1000&auto=format&fit=crop');">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                <div class="p-6 relative z-10 w-full">
                    <span class="bg-emerald-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide mb-2 inline-block">Tutorial</span>
                    <h1 id="tut-title" class="text-2xl font-bold text-white">Selamat Datang</h1>
                </div>
            </div>
            <div class="p-6 flex-1 overflow-y-auto custom-scroll" id="tutorial-content"></div>
            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                <div class="flex space-x-2" id="tutorial-dots"></div>
                <button id="tutorial-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-2.5 rounded-lg font-bold shadow-lg transition transform hover:scale-105">Lanjut</button>
            </div>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="hidden fixed inset-0 z-[2000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center animate-bounce-in">
            <div id="result-icon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-white"></div>
            <h2 id="result-title" class="text-2xl font-black mb-1 text-gray-800">Hebat!</h2>
            <p id="result-message" class="text-gray-600 text-sm mb-6 px-4">Tebakan Anda sangat akurat.</p>
            <div class="flex gap-3 mb-6">
                <div class="flex-1 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="text-[10px] text-gray-400 uppercase font-bold">Jarak</div>
                    <div id="result-distance" class="font-mono font-bold text-lg text-gray-700">0 km</div>
                </div>
                <div class="flex-1 bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                    <div class="text-[10px] text-emerald-600 uppercase font-bold">Poin</div>
                    <div id="result-points" class="font-mono font-bold text-lg text-emerald-600">+100</div>
                </div>
            </div>
            <button id="result-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">Lanjut Level Berikutnya</button>
        </div>
    </div>

    <!-- MINI QUIZ MODAL -->
    <div id="mini-quiz-modal" class="hidden fixed inset-0 z-[2500] bg-black/70 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-center">
                <h2 class="text-2xl font-bold text-white"><i class="fa-solid fa-brain mr-2"></i> Mini Quiz</h2>
                <p id="mini-quiz-level" class="text-blue-100 text-sm mt-1">Level 1 Review</p>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <p id="mini-quiz-question" class="text-lg font-bold text-gray-800 mb-4"></p>
                    <div id="mini-quiz-options" class="space-y-3">
                        <!-- Options akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div id="mini-quiz-progress" class="text-sm text-gray-500 font-bold">
                        Soal <span id="current-quiz">1</span>/3
                    </div>
                    <div id="mini-quiz-feedback" class="hidden text-sm font-bold"></div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-t flex justify-between items-center">
                <button id="mini-quiz-next" onclick="nextMiniQuizQuestion()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg transition transform hover:scale-105 hidden">
                    Soal Selanjutnya <i class="fa-solid fa-arrow-right ml-1"></i>
                </button>
                <button id="mini-quiz-finish" onclick="finishMiniQuiz()" 
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg transition transform hover:scale-105 hidden">
                    Selesaikan Quiz <i class="fa-solid fa-check ml-1"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- LEADERBOARD MODAL -->
    <div id="leaderboard-modal" class="hidden fixed inset-0 z-[2500] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white"><i class="fa-solid fa-trophy text-yellow-300 mr-2"></i> Papan Peringkat</h2>
                <div class="text-white text-right">
                    <p class="text-xs opacity-75 uppercase font-bold">Skor Anda</p>
                    <p id="leaderboard-my-score" class="text-2xl font-bold">0</p>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <p id="submission-status" class="text-center text-sm font-semibold text-gray-500 animate-pulse">Mengirim data ke server...</p>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-0">
                <table class="w-full leaderboard-table">
                    <thead>
                        <tr>
                            <th class="w-16 text-center">#</th>
                            <th>Nama</th>
                            <th>Sekolah</th>
                            <th class="hidden sm:table-cell">Provinsi</th>
                            <th class="text-right">Skor</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Data injected via JS -->
                    </tbody>
                </table>
            </div>

            <div class="p-4 bg-white border-t border-gray-200 text-center">
                <button onclick="location.reload()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition transform hover:scale-105">
                    <i class="fa-solid fa-rotate-right mr-2"></i> Main Lagi
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        let db, auth, currentUser, appId = 'default-bioexplorer';

        const initFirebase = async () => {
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bioexplorer';
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    const userCredential = await signInAnonymously(auth);
                    currentUser = userCredential.user;
                }
            } catch (e) { console.error("Firebase init error:", e); }
        };
        initFirebase();

        window.handleLoginSubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('input-name').value;
            const school = document.getElementById('input-school').value;
            const province = document.getElementById('input-province').value;

            if (name && school && province) {
                // UPDATE GLOBAL STATE
                window.playerProfile = { name, school, province };
                
                document.getElementById('player-name-display').innerText = name;
                document.getElementById('login-modal').classList.add('hidden');
                
                // START BACKGROUND MUSIC
                try {
                    const bgMusic = document.getElementById('background-music');
                    bgMusic.volume = 0.5; // Set volume to 50%
                    await bgMusic.play();
                    console.log("Background music started");
                } catch (error) {
                    console.log("Could not play background music:", error);
                }
                
                // Show Level 1 Tutorial
                window.showTutorialForLevel(1);
                
                // Analytics (Save login info)
                if (db && currentUser) {
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles'), {
                            name, school, province, loginTime: serverTimestamp()
                        });
                    } catch (error) { console.error(error); }
                }
            }
        };
        document.getElementById('login-form').addEventListener('submit', window.handleLoginSubmit);
    </script>

    <script>
        /**
         * KONFIGURASI DATABASE
         * GANTI URL DI BAWAH INI DENGAN URL APPS SCRIPT ANDA
         */
        const SPECIES_API_URL = "https://script.google.com/macros/s/AKfycbx7axI1BI7B79H6XEIWbUPJSa8TmLsivdx6feh5avUzxBVplrykEdNvo71YFVOe5Wkp/exec";
        const LEADERBOARD_API_URL = "https://script.google.com/macros/s/AKfycbyodd3NTLH2B0Qi43v5ffN9bcmLNjKreYbIQseDMP9JNTZOYey7hI9hKmJIyGcq4rCo/exec"; 

        // Mode debug - set true untuk melihat detail koneksi
        const DEBUG_MODE = false; // Ubah menjadi false untuk menyembunyikan debug info

        // --- GAME STATE & VARIABLES ---
        let map;
        let markersClusterGroup;
        let quizMarkers = [];
        let polylines = [];
        
        let gameState = {
            phase: 'loading', 
            level: 1, 
            score: 0,
            explorationCount: 0,
            visitedExplorationIds: new Set(),
            currentQuizIndex: 0
        };

        // --- DATABASE (DINAMIS DARI SPREADSHEET) --- 
        let fullData = [];
        let quizData = [];
        let useOnlineDatabase = false;

        // Fungsi untuk test koneksi ke server
        async function testConnection() {
            try {
                updateLoadingStatus("Testing koneksi ke server...", 20);
                
                // Tampilkan animasi loading di debug info jika DEBUG_MODE aktif
                const debugInfo = document.getElementById('api-debug-info');
                const debugLoading = document.getElementById('debug-loading');
                const debugDetails = document.getElementById('debug-details');
                
                if (DEBUG_MODE) {
                    debugInfo.classList.remove('hidden');
                    debugLoading.classList.remove('hidden');
                    debugDetails.classList.add('hidden');
                } else {
                    // Sembunyikan debug info jika tidak dalam DEBUG_MODE
                    debugInfo.classList.add('hidden');
                }
                
                // Tambahkan timestamp untuk menghindari cache
                const testUrl = `${SPECIES_API_URL}?action=test&timestamp=${Date.now()}`;
                
                // Sembunyikan URL dari tampilan kecuali benar-benar diperlukan
                if (DEBUG_MODE && document.getElementById('api-url-display')) {
                    // Hanya tampilkan domain saja, bukan full URL
                    const urlObj = new URL(testUrl);
                    document.getElementById('api-url-display').textContent = `URL: ${urlObj.origin}...`;
                }
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                // Sembunyikan loading animasi
                if (DEBUG_MODE && debugLoading) {
                    debugLoading.classList.add('hidden');
                    debugDetails.classList.remove('hidden');
                }
                
                if (DEBUG_MODE && document.getElementById('api-response-status')) {
                    document.getElementById('api-response-status').textContent = 
                        `Status: ${response.status} ${response.statusText}`;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    console.log("Connection test successful:", data);
                    return { success: true, data: data };
                } else {
                    console.warn("Server responded with error:", response.status);
                    
                    // Sembunyikan debug info jika terjadi error dan tidak dalam DEBUG_MODE
                    if (!DEBUG_MODE) {
                        debugInfo.classList.add('hidden');
                    }
                    
                    return { 
                        success: false, 
                        error: `Server error: ${response.status} ${response.statusText}` 
                    };
                }
                
            } catch (error) {
                console.error("Connection test failed:", error);
                
                // Sembunyikan debug info jika terjadi error dan tidak dalam DEBUG_MODE
                if (!DEBUG_MODE) {
                    document.getElementById('api-debug-info').classList.add('hidden');
                }
                
                return { 
                    success: false, 
                    error: error.message || "Tidak dapat terhubung ke server" 
                };
            }
        }

        // Fungsi untuk mengambil data dari Google Apps Script
        async function fetchSpeciesData() {
            try {
                updateLoadingStatus("Menginisialisasi sistem...", 10);
                
                // Test koneksi dulu
                const connectionTest = await testConnection();
                
                if (!connectionTest.success) {
                    console.warn("Cannot connect to server, using fallback data");
                    showConnectionError(connectionTest.error);
                    updateLoadingStatus("Menggunakan data lokal...", 50);
                    setTimeout(() => {
                        generateFallbackData();
                        hideLoadingShowLogin();
                        updateDatabaseStatus("Tidak terhubung ke database. Menggunakan data lokal.");
                    }, 1000);
                    return;
                }
                
                // Jika koneksi berhasil, ambil data spesies
                useOnlineDatabase = true;
                updateLoadingStatus("Mengambil data spesies dari database...", 40);
                
                // Ambil data spesies
                const speciesUrl = `${SPECIES_API_URL}?action=getSpecies&timestamp=${Date.now()}`;
                const response = await fetch(speciesUrl, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                updateLoadingStatus("Memproses data...", 70);
                
                // Check jika ada error dari server
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Pastikan ada data
                let speciesArray = [];
                if (result.data && Array.isArray(result.data)) {
                    speciesArray = result.data;
                } else if (Array.isArray(result)) {
                    speciesArray = result;
                } else {
                    throw new Error("Format data tidak valid");
                }
                
                if (speciesArray.length === 0) {
                    throw new Error("Data kosong dari server");
                }
                
                // Format data dari spreadsheet
                fullData = speciesArray.map((item, index) => {
                    // Debug: log item untuk melihat struktur data
                    if (DEBUG_MODE && index < 3) {
                        console.log(`Sample data item ${index}:`, item);
                    }
                    
                    // Access properties - handle both lowercase and original case
                    const name = item.nama || item.Nama || item.name || item.Name || `Spesies ${index + 1}`;
                    const scientific = item.nama_ilmiah || item.Nama_Ilmiah || item.scientific_name || item.Scientific_Name || item.sc ||"Nama Ilmiah";
                    const typeRaw = item.jenis || item.Jenis || item.type || item.Type || "fauna";
                    const type = typeRaw.toString().toLowerCase();
                    const region = item.region || item.Region || item.pulau || item.Pulau || "Indonesia";
                    const desc = item.deskripsi || item.Deskripsi || item.description || item.Description || item.desc ||"Deskripsi tidak tersedia";
                    const lat = parseFloat(item.latitude || item.Latitude || item.lat || item.Lat) || getRandomLat();
                    const lng = parseFloat(item.longitude || item.Longitude || item.lng || item.Lng) || getRandomLng();
                    const traits = item.ciri_khas || item.Ciri_Khas || item.traits || item.Traits || "<ul><li>Ciri khas tidak tersedia</li></ul>";
                    const image = item.gambar || item.Gambar || item.image_url || item.Image_URL || getDefaultImage(type);
                    
                    return {
                        id: `spec_${index}`,
                        name: name,
                        sc: scientific,
                        type: type,
                        region: region,
                        desc: desc,
                        lat: lat,
                        lng: lng,
                        traits: traits,
                        image_url: image,
                        isClone: false
                    };
                });
                
                updateLoadingStatus("Menyiapkan data quiz...", 85);
                
                // Setup Quiz Data (hanya fauna untuk level 3)
                const faunaData = fullData.filter(s => s.type === 'fauna');
                quizData = faunaData
                    .sort(() => 0.5 - Math.random()) 
                    .slice(0, Math.min(10, faunaData.length))
                    .map(s => {
                        let z = getZoneFromLong(s.lng);
                        return {
                            ...s,
                            zone: z,
                            hint: `Habitat spesies ini ada di ${s.region}.`
                        };
                    });
                    
                console.log("✅ Data berhasil diambil dari server:", fullData.length, "spesies");
                console.log("✅ Data quiz disiapkan:", quizData.length, "spesies fauna");
                
                updateLoadingStatus("Data siap!", 100);
                
                // Tampilkan status database berhasil
                setTimeout(() => {
                    hideLoadingShowLogin();
                    updateDatabaseStatus(`Terhubung ke database online (${fullData.length} spesies)`);
                    showSuccessMessage("Berhasil terhubung ke database!");
                }, 500);
                
            } catch (error) {
                console.error("❌ Error fetching data from server:", error);
                showConnectionError(error.message);
                updateLoadingStatus(`Gagal: ${error.message}. Menggunakan data lokal...`, 50);
                
                // Fallback ke data lokal jika fetch gagal
                setTimeout(() => {
                    generateFallbackData();
                    hideLoadingShowLogin();
                    updateDatabaseStatus("Tidak terhubung ke database. Menggunakan data lokal.");
                }, 1000);
            }
        }

        // Fungsi untuk menampilkan error koneksi
        function showConnectionError(errorMessage) {
            const debugDiv = document.getElementById('connection-test-result');
            if (debugDiv) {
                debugDiv.innerHTML = `
                    <div class="error-message">
                        <p class="font-bold mb-1"><i class="fas fa-exclamation-triangle mr-2"></i>Koneksi Gagal</p>
                        <p class="text-sm">${errorMessage}</p>
                        <p class="text-xs mt-2">Game akan menggunakan data lokal.</p>
                    </div>
                `;
            }
            
            // Sembunyikan debug info ketika terjadi error
            if (!DEBUG_MODE) {
                document.getElementById('api-debug-info').classList.add('hidden');
            }
        }

        // Fungsi untuk menampilkan pesan sukses
        function showSuccessMessage(message) {
            const debugDiv = document.getElementById('connection-test-result');
            if (debugDiv) {
                debugDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 text-green-700 p-3 rounded-lg">
                        <p class="font-bold mb-1"><i class="fas fa-check-circle mr-2"></i>${message}</p>
                    </div>
                `;
            }
            
            // Sembunyikan debug info setelah sukses jika tidak dalam DEBUG_MODE
            if (!DEBUG_MODE) {
                document.getElementById('api-debug-info').classList.add('hidden');
            }
        }

        // Fungsi untuk update status database di login modal
        function updateDatabaseStatus(message) {
            const statusEl = document.getElementById('db-status-text');
            if (statusEl) {
                statusEl.textContent = message;
                
                // Update warna berdasarkan status
                const statusContainer = document.getElementById('database-status');
                if (message.includes("Terhubung")) {
                    statusContainer.className = "mb-4 p-3 rounded-lg bg-green-50 border border-green-200";
                    statusEl.className = "text-sm text-green-700 font-medium";
                } else {
                    statusContainer.className = "mb-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200";
                    statusEl.className = "text-sm text-yellow-700 font-medium";
                }
            }
        }

        // Fungsi untuk update status loading
        function updateLoadingStatus(message, progress) {
            const statusEl = document.getElementById('loading-status');
            const messageEl = document.getElementById('loading-message');
            const progressBar = document.getElementById('loading-progress');
            
            if (statusEl) statusEl.textContent = message;
            if (messageEl) messageEl.textContent = message;
            if (progressBar) progressBar.style.width = `${progress}%`;
        }

        function hideLoadingShowLogin() {
            document.getElementById('loading-modal').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('hidden');
        }

        // Fungsi untuk data fallback lokal
        function generateFallbackData() {
            console.log("🔄 Menggunakan data fallback lokal...");
            
            const fallbackData = [
                { 
                    name: "Harimau Sumatera", sc: "Panthera tigris sumatrae", type: "fauna", region: "Sumatera", 
                    desc: "Predator puncak yang kritis terancam punah. Hanya tersisa di Pulau Sumatera.", 
                    lat: -0.5, lng: 101.5,
                    traits: "<ul><li>Tubuh paling kecil di antara semua subspesies harimau.</li><li>Loreng hitam lebih rapat dan tebal.</li><li>Janggut atau surai di pipi terlihat jelas.</li></ul>",
                    image_url: "https://images.unsplash.com/photo-1546182990-dffeafbe841d?q=80&w=800&auto=format&fit=crop"
                },
                { 
                    name: "Rafflesia Arnoldii", sc: "Rafflesia arnoldii", type: "flora", region: "Sumatera", 
                    desc: "Bunga tunggal terbesar di dunia, ikon Bengkulu.", 
                    lat: -3.8, lng: 102.3,
                    traits: "<ul><li>Bunga raksasa tanpa batang, daun, atau akar sejati.</li><li>Diameter bunga bisa mencapai 1 meter.</li><li>Mengeluarkan bau busuk untuk menarik lalat.</li></ul>",
                    image_url: "https://images.unsplash.com/photo-1516048015719-fb6a4c7c71f1?q=80&w=800&auto=format&fit=crop"
                },
                { 
                    name: "Orangutan Sumatera", sc: "Pongo abelii", type: "fauna", region: "Sumatera", 
                    desc: "Primata cerdas penghuni hutan Leuser.", 
                    lat: 3.5, lng: 97.5,
                    traits: "<ul><li>Bulu berwarna oranye kemerahan terang.</li><li>Lengan panjang dan kuat untuk bergelantungan.</li><li>Wajah jantan dewasa memiliki bantalan pipi (cheekpad) lebar.</li></ul>",
                    image_url: "https://images.unsplash.com/photo-1559253664-ca249d4608c6?q=80&w=800&auto=format&fit=crop"
                },
                { 
                    name: "Komodo", sc: "Varanus komodoensis", type: "fauna", region: "Nusa Tenggara", 
                    desc: "Kadal purba terbesar di dunia.", 
                    lat: -8.6, lng: 119.5,
                    traits: "<ul><li>Memiliki tubuh besar dengan panjang bisa mencapai 2–3 meter.</li><li>Kulit bersisik kasar berwarna cokelat keabu-abuan.</li><li>Lidah panjang bercabang seperti ular dan sering menjilati udara.</li></ul>",
                    image_url: "https://images.unsplash.com/photo-1578774632741-8559c7a52e53?q=80&w=800&auto=format&fit=crop"
                },
                { 
                    name: "Cendrawasih Botak", sc: "Cicinnurus respublica", type: "fauna", region: "Papua", 
                    desc: "Burung surga cantik dari Raja Ampat.", 
                    lat: -0.5, lng: 130.8,
                    traits: "<ul><li>Kepala botak dengan kulit berwarna biru cerah.</li><li>Pola salib hitam di atas punggung merah.</li><li>Dua bulu ekor melengkung spiral.</li></ul>",
                    image_url: "https://images.unsplash.com/photo-1551085254-e96b210db58a?q=80&w=800&auto=format&fit=crop"
                },
                { 
                    name: "Badak Jawa", sc: "Rhinoceros sondaicus", type: "fauna", region: "Jawa", 
                    desc: "Mamalia paling langka di dunia, hanya ada di Ujung Kulon.", 
                    lat: -6.75, lng: 105.35,
                    traits: "<ul><li>Hanya memiliki satu cula kecil (betina sering tanpa cula).</li><li>Kulit abu-abu dengan lipatan menyerupai baju zirah.</li><li>Bibir atas meruncing untuk memegang daun.</li></ul>",
                    image_url: "https://images.unsplash.com/photo-1589656966895-2f33e7653819?q=80&w=800&auto=format&fit=crop"
                },
                { 
                    name: "Bunga Bangkai", sc: "Amorphophallus titanum", type: "flora", region: "Sumatera", 
                    desc: "Bunga majemuk tertinggi di dunia, baunya memikat serangga.", 
                    lat: -0.1, lng: 100.6,
                    traits: "<ul><li>Memiliki tongkol (spadix) yang menjulang tinggi.</li><li>Kelopak (spatha) berwarna merah hati.</li><li>Mengeluarkan bau menyengat seperti daging busuk saat mekar.</li></ul>",
                    image_url: "https://images.unsplash.com/photo-1597076881087-8b96c6dcf8e9?q=80&w=800&auto=format&fit=crop"
                },
                { 
                    name: "Bekantan", sc: "Nasalis larvatus", type: "fauna", region: "Kalimantan", 
                    desc: "Monyet hidung panjang penghuni hutan bakau.", 
                    lat: -3.3, lng: 114.6,
                    traits: "<ul><li>Hidung jantan sangat besar dan menggantung.</li><li>Perut buncit karena sistem pencernaan khusus daun.</li><li>Bulu oranye kemerahan dengan punggung abu-abu.</li></ul>",
                    image_url: "https://images.unsplash.com/photo-1559253664-ca249d4608c6?q=80&w=800&auto=format&fit=crop"
                }
            ];
            
            fullData = fallbackData.map((d, index) => ({ ...d, id: `spec_${index}` }));
            
            // Setup Quiz Data
            quizData = fullData
                .filter(s => s.type === 'fauna')
                .sort(() => 0.5 - Math.random()) 
                .slice(0, Math.min(10, fullData.filter(s => s.type === 'fauna').length))
                .map(s => {
                    let z = getZoneFromLong(s.lng);
                    return {
                        ...s,
                        zone: z,
                        hint: `Habitat spesies ini ada di ${s.region}.`
                    };
                });
                
            console.log("✅ Data fallback siap:", fullData.length, "spesies");
        }

        // Helper function untuk random lat/lng jika tidak ada data
        function getRandomLat() {
            return -2 + (Math.random() * 10 - 5);
        }

        function getRandomLng() {
            return 118 + (Math.random() * 20 - 10);
        }

        // Helper function untuk gambar default berdasarkan jenis
        function getDefaultImage(type) {
            const isFlora = type.toString().toLowerCase() === 'flora';
            if (isFlora) {
                return "https://images.unsplash.com/photo-1516048015719-fb6a4c7c71f1?q=80&w=800&auto=format&fit=crop";
            } else {
                return "https://images.unsplash.com/photo-1546182990-dffeafbe841d?q=80&w=800&auto=format&fit=crop";
            }
        }

        function getZoneFromLong(lng) {
            if(lng < 117) return "Asiatis";
            if(lng < 129) return "Wallacea";
            return "Australis";
        }

        // --- AUDIO FUNCTIONS ---
        function playSound(soundId) {
            try {
                const sound = document.getElementById(soundId);
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Could not play sound:", e));
            } catch (error) {
                console.log("Error playing sound:", error);
            }
        }

        function playMissionCompleteSound() {
            playSound('mission-complete-sound');
        }

        function playMiniQuizSound() {
            playSound('mini-quiz-sound');
        }

        function playCoinSound() {
            playSound('coin-sound');
        }

        function playVisitedSound() {
            playSound('visited-sound');
        }

        function playSuccessSound() {
            playSound('success-sound');
        }

        function playWrongSound() {
            playSound('wrong-sound');
        }

        // --- FUNGSI UNTUK MENAMPILKAN POPUP SKOR SEMENTARA ---
        function showTemporaryScorePopup(title, message, score, level) {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            
            modal.classList.remove('hidden');
            document.getElementById('result-title').innerText = title;
            document.getElementById('result-message').innerText = message;
            document.getElementById('result-distance').parentElement.style.display = 'none';
            document.getElementById('result-points').innerText = `+${score}`;
            document.querySelector('#result-points').previousElementSibling.innerText = "SKOR SEMENTARA";
            
            // Atur icon dan warna berdasarkan level
            if (level === 1) {
                icon.innerHTML = '<i class="fa-solid fa-seedling text-emerald-500"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-emerald-100";
            } else {
                icon.innerHTML = '<i class="fa-solid fa-paw text-purple-500"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-purple-100";
            }
            
            // Mainkan suara misi selesai
            playMissionCompleteSound();
            
            // Ubah tombol
            const btn = document.getElementById('result-btn');
            btn.innerText = level === 1 ? "Lanjut Level 2" : "Lanjut Level 3";
            btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5";
            
            if (level === 1) {
                btn.onclick = () => {
                    document.getElementById('result-modal').classList.add('hidden');
                    window.showTutorialForLevel(2);
                };
            } else {
                btn.onclick = () => {
                    document.getElementById('result-modal').classList.add('hidden');
                    finishZoneExploration();
                };
            }
        }

        // --- MINI QUIZ SYSTEM ---
        const miniQuizQuestions = {
            level1: [
                {
                    question: "Bunga Rafflesia Arnoldii terkenal karena...",
                    options: [
                        "Baunya yang harum",
                        "Ukurannya yang besar",
                        "Warnanya yang cerah",
                        "Batangnya yang tinggi"
                    ],
                    correct: 1,
                    points: 100,
                    penalty: 50
                },
                {
                    question: "Harimau Sumatera memiliki ciri khas...",
                    options: [
                        "Tubuh paling besar di antara harimau",
                        "Loreng yang lebih rapat",
                        "Warna bulu putih",
                        "Tidak bisa berenang"
                    ],
                    correct: 1,
                    points: 100,
                    penalty: 50
                },
                {
                    question: "Badak Sumatera adalah badak terkecil di dunia dan memiliki...",
                    options: [
                        "Satu cula",
                        "Dua cula",
                        "Tiga cula",
                        "Tidak bercula"
                    ],
                    correct: 1,
                    points: 100,
                    penalty: 50
                }
            ],
            level2: [
                {
                    question: "Orangutan Kalimantan memiliki ciri khas...",
                    options: [
                        "Wajah lebih lebar dan gelap",
                        "Tubuh lebih kecil dari Orangutan Sumatera",
                        "Warna bulu hitam pekat",
                        "Hidup di tanah saja"
                    ],
                    correct: 0,
                    points: 100,
                    penalty: 50
                },
                {
                    question: "Komodo memiliki lidah yang...",
                    options: [
                        "Pendek dan lebar",
                        "Panjang bercabang seperti ular",
                        "Berwarna biru cerah",
                        "Tidak memiliki lidah"
                    ],
                    correct: 1,
                    points: 100,
                    penalty: 50
                },
                {
                    question: "Cendrawasih Botak memiliki ciri khas...",
                    options: [
                        "Kepala botak dengan kulit biru cerah",
                        "Bulu seluruh tubuh berwarna merah",
                        "Tidak bisa terbang",
                        "Hidup di air"
                    ],
                    correct: 0,
                    points: 100,
                    penalty: 50
                }
            ]
        };

        let currentMiniQuiz = {
            level: 1,
            questions: [],
            currentQuestionIndex: 0,
            score: 0,
            answered: false
        };

        // Fungsi untuk memulai Mini Quiz
        function startMiniQuiz(level) {
            currentMiniQuiz = {
                level: level,
                questions: level === 1 ? [...miniQuizQuestions.level1] : [...miniQuizQuestions.level2],
                currentQuestionIndex: 0,
                score: 0,
                answered: false
            };
            
            document.getElementById('mini-quiz-modal').classList.remove('hidden');
            document.getElementById('mini-quiz-level').textContent = `Review Level ${level}`;
            
            // Mainkan sound tring untuk mini quiz
            playMiniQuizSound();
            
            loadMiniQuizQuestion();
        }

        // Fungsi untuk memuat pertanyaan
        function loadMiniQuizQuestion() {
            const quiz = currentMiniQuiz;
            const question = quiz.questions[quiz.currentQuestionIndex];
            
            document.getElementById('mini-quiz-question').textContent = question.question;
            document.getElementById('current-quiz').textContent = quiz.currentQuestionIndex + 1;
            
            const optionsContainer = document.getElementById('mini-quiz-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'w-full text-left p-3 rounded-lg border border-gray-300 hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 font-medium';
                button.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full border border-gray-400 flex items-center justify-center mr-3">
                            <span class="text-xs font-bold">${String.fromCharCode(65 + index)}</span>
                        </div>
                        <span>${option}</span>
                    </div>
                `;
                button.onclick = () => selectMiniQuizAnswer(index);
                optionsContainer.appendChild(button);
            });
            
            // Reset UI
            document.getElementById('mini-quiz-feedback').classList.add('hidden');
            document.getElementById('mini-quiz-next').classList.add('hidden');
            document.getElementById('mini-quiz-finish').classList.add('hidden');
            currentMiniQuiz.answered = false;
        }

        // Fungsi untuk memilih jawaban
        function selectMiniQuizAnswer(selectedIndex) {
            if (currentMiniQuiz.answered) return;
            
            currentMiniQuiz.answered = true;
            const question = currentMiniQuiz.questions[currentMiniQuiz.currentQuestionIndex];
            const options = document.querySelectorAll('#mini-quiz-options button');
            const feedback = document.getElementById('mini-quiz-feedback');
            
            // Highlight jawaban
            options.forEach((option, index) => {
                if (index === question.correct) {
                    option.classList.add('bg-green-100', 'border-green-500');
                    option.querySelector('div div').classList.add('bg-green-500', 'text-white', 'border-green-600');
                } else if (index === selectedIndex && selectedIndex !== question.correct) {
                    option.classList.add('bg-red-100', 'border-red-500');
                    option.querySelector('div div').classList.add('bg-red-500', 'text-white', 'border-red-600');
                }
                option.classList.add('pointer-events-none');
            });
            
            // Cek jawaban
            if (selectedIndex === question.correct) {
                currentMiniQuiz.score += question.points;
                gameState.score += question.points;
                feedback.textContent = `Benar! +${question.points} poin`;
                feedback.className = "text-green-600 font-bold text-sm";
                playSuccessSound();
            } else {
                gameState.score -= question.penalty;
                feedback.textContent = `Salah! -${question.penalty} poin`;
                feedback.className = "text-red-600 font-bold text-sm";
                playWrongSound();
            }
            
            feedback.classList.remove('hidden');
            updateScoreDisplays();
            
            // Tampilkan tombol selanjutnya
            if (currentMiniQuiz.currentQuestionIndex < currentMiniQuiz.questions.length - 1) {
                document.getElementById('mini-quiz-next').classList.remove('hidden');
            } else {
                document.getElementById('mini-quiz-finish').classList.remove('hidden');
            }
        }

        // Fungsi untuk ke soal berikutnya
        function nextMiniQuizQuestion() {
            currentMiniQuiz.currentQuestionIndex++;
            loadMiniQuizQuestion();
        }

        // Fungsi untuk menyelesaikan quiz
        function finishMiniQuiz() {
            document.getElementById('mini-quiz-modal').classList.add('hidden');
            
            // Tampilkan popup skor sementara
            if (currentMiniQuiz.level === 1) {
                showTemporaryScorePopup(
                    "Level 1 Selesai!",
                    `Selamat! Anda menyelesaikan eksplorasi umum.`,
                    currentMiniQuiz.score,
                    1
                );
            } else if (currentMiniQuiz.level === 2) {
                showTemporaryScorePopup(
                    "Level 2 Selesai!",
                    `Hebat! Anda memahami zona biogeografi dengan baik.`,
                    currentMiniQuiz.score,
                    2
                );
            }
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("🚀 Initializing BioExplorer Nusantara...");
            
            // Inisialisasi peta
            initMap();
            
            // Tampilkan loading modal
            document.getElementById('loading-modal').classList.remove('hidden');
            
            // Load data dari database
            try {
                await fetchSpeciesData();
            } catch (error) {
                console.error("Error in initialization:", error);
                // Fallback jika semua gagal
                updateLoadingStatus("Error inisialisasi, menggunakan data lokal...", 30);
                setTimeout(() => {
                    generateFallbackData();
                    hideLoadingShowLogin();
                    updateDatabaseStatus("Error inisialisasi. Menggunakan data lokal.");
                }, 1000);
            }
        });

        function initMap() {
            map = L.map('map', {
                center: [-2.5, 118],
                zoom: 5,
                zoomControl: false,
                minZoom: 4,
                maxBounds: [[10, 90], [-15, 145]]
            });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);

            // Draw Lines
            const wallace = L.polyline([[4.5, 118.5], [0.5, 118.5], [-1.5, 117.5], [-8.5, 115.5], [-11.0, 116.0]], { color: '#ef4444', dashArray: '10,10', weight: 2 }).addTo(map);
            wallace.bindTooltip("Garis Wallace", {permanent: true, direction: "right", className: "bg-transparent border-0 text-red-600 font-bold"});
            
            const weber = L.polyline([[2.5, 129.5], [-3.5, 126.5], [-5.5, 128.5], [-8.5, 131.5]], { color: '#3b82f6', dashArray: '10,10', weight: 2 }).addTo(map);
            weber.bindTooltip("Garis Weber", {permanent: true, direction: "right", className: "bg-transparent border-0 text-blue-600 font-bold"});
            
            polylines.push(wallace, weber);
            
            map.on('click', handleMapClick);
        }

        function toggleMapLayers() {
            const hasLayer = map.hasLayer(polylines[0]);
            polylines.forEach(p => hasLayer ? map.removeLayer(p) : map.addLayer(p));
        }

        // --- TUTORIAL LOGIC & DATA ---
        
        // Tutorial Level 1
        const level1Slides = [
            {
                title: "Selamat Datang Explorer!",
                content: `<p class="mb-2">Misi Anda adalah menjelajahi kekayaan hayati Indonesia dalam 3 Tahap.</p>
                         <ul class="list-disc pl-5 text-sm space-y-2 mb-4 text-gray-600">
                            <li><b>Level 1:</b> Eksplorasi Umum (20 Spesies).</li>
                            <li><b>Level 2:</b> Pendalaman Zona Biogeografi (20 Fauna).</li>
                            <li><b>Level 3:</b> Kuis Tebak Lokasi.</li>
                         </ul>`
            },
            {
                title: "Navigasi Peta",
                content: `<p class="mb-3">Gunakan tombol <b>Filter</b> di level 1 untuk memilih Flora atau Fauna.</p>
                          <p class="text-sm">Titik yang berdekatan akan mengelompok (Cluster). Klik cluster untuk memperbesar.</p>`
            },
            {
                title: "Mulai Level 1",
                content: `<p>Setiap temuan baru memberi poin. Pelajari ciri-ciri hewan di Level 2 nanti karena akan berguna saat Kuis!</p>
                          <p class="mt-4 text-center font-bold text-emerald-600">Siap?</p>`
            }
        ];

        // Tutorial Level 2
        const level2Slides = [
            {
                title: "Level 2: Zona Biogeografi",
                content: `<p class="mb-2">Selamat! Anda lulus tahap dasar. Sekarang masuk ke tahap pendalaman.</p>
                          <p class="text-sm text-gray-600">Fokus kita sekarang adalah <b>3 Zona Biogeografi</b>: Asiatis, Wallacea, dan Australis.</p>`
            },
            {
                title: "Misi Baru",
                content: `<ul class="list-disc pl-5 text-sm space-y-2 mb-4 text-gray-600">
                            <li>Jelajahi kembali peta untuk menemukan <b>20 Fauna</b>.</li>
                            <li><b>PENTING:</b> Klik hewan untuk membaca <b>Ciri Khas Fisik</b> mereka.</li>
                            <li>Perhatikan detail seperti bentuk tubuh, warna, dan kebiasaan unik hewan tersebut!</li>
                         </ul>`
            }
        ];

        // Tutorial Level 3
        const level3Slides = [
            {
                title: "Level 3: Kuis Tebak Lokasi",
                content: `<p class="mb-2">Ini adalah ujian sesungguhnya bagi seorang BioExplorer.</p>
                          <p class="text-sm text-gray-600">Anda akan diberikan nama hewan dan deskripsi, tugas Anda adalah menunjuk lokasi aslinya di peta.</p>`
            },
            {
                title: "Sistem Skor",
                content: `<p class="mb-2">Akurasi adalah segalanya.</p>
                          <ul class="list-disc pl-5 text-sm space-y-1 mb-4 text-gray-600">
                            <li><b>< 50 km:</b> 100 Poin (Sempurna)</li>
                            <li><b>< 200 km:</b> 80 Poin</li>
                            <li><b>Salah Zona:</b> Poin rendah!</li>
                         </ul>
                         <p class="font-bold text-emerald-600 text-center mt-4">Buktikan pengetahuanmu!</p>`
            }
        ];

        let currentSlides = [];
        let nextLevelCallback = null;

        window.showTutorialForLevel = function(level) {
            document.getElementById('tutorial-modal').classList.remove('hidden');
            
            if (level === 1) {
                currentSlides = level1Slides;
                nextLevelCallback = startExplorationPhase;
            } else if (level === 2) {
                currentSlides = level2Slides;
                nextLevelCallback = startZoneExplorationPhase;
            } else if (level === 3) {
                currentSlides = level3Slides;
                nextLevelCallback = startQuizPhase;
            }
            
            renderTutorial(0);
        }

        function renderTutorial(index) {
            document.getElementById('tut-title').innerText = currentSlides[index].title;
            document.getElementById('tutorial-content').innerHTML = currentSlides[index].content;
            
            const dots = document.getElementById('tutorial-dots');
            dots.innerHTML = currentSlides.map((_, i) => `<div class="h-2 rounded-full transition-all ${i === index ? 'w-6 bg-emerald-500' : 'w-2 bg-gray-300'}"></div>`).join('');
            
            const btn = document.getElementById('tutorial-btn');
            if (index < currentSlides.length - 1) {
                btn.innerText = "Lanjut";
                btn.onclick = () => renderTutorial(index + 1);
            } else {
                btn.innerText = "Mulai";
                btn.onclick = () => {
                    document.getElementById('tutorial-modal').classList.add('hidden');
                    if (nextLevelCallback) nextLevelCallback();
                };
            }
        }

        // --- LEVEL 1: GENERAL EXPLORATION ---
        async function startExplorationPhase() {
            gameState.phase = 'exploration';
            gameState.level = 1;
            
            // HUD
            document.getElementById('game-hud').classList.remove('hidden');
            document.getElementById('exploration-controls').classList.remove('hidden');
            document.getElementById('level1-filters').classList.remove('hidden');
            document.getElementById('level2-indicator').classList.add('hidden');
            
            document.getElementById('level-display').innerText = "1: Eksplorasi Umum";
            updateScoreDisplays();
            updateExplorationUI();

            setupMarkersLevel1();
        }

        function setupMarkersLevel1() {
            if (markersClusterGroup) map.removeLayer(markersClusterGroup);

            markersClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 40,
                iconCreateFunction: function(cluster) {
                    return L.divIcon({ 
                        html: '<div class="w-10 h-10 bg-emerald-600 rounded-full text-white flex items-center justify-center font-bold border-2 border-white shadow-lg">' + cluster.getChildCount() + '</div>', 
                        className: 'bg-transparent', 
                        iconSize: L.point(40, 40) 
                    });
                }
            });
            map.addLayer(markersClusterGroup);
            filterMarkers('all');
        }

        window.filterMarkers = function(type) {
            markersClusterGroup.clearLayers();
            
            // UI States
            ['btn-all', 'btn-flora', 'btn-fauna'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('active', 'bg-emerald-600', 'text-white', 'border-emerald-600');
                el.classList.add('text-gray-600', 'border-gray-300');
            });
            const activeId = `btn-${type}`;
            const activeEl = document.getElementById(activeId);
            activeEl.classList.add('active', 'bg-emerald-600', 'text-white', 'border-emerald-600');
            activeEl.classList.remove('text-gray-600', 'border-gray-300');

            const filteredData = type === 'all' ? fullData : fullData.filter(d => d.type === type);

            filteredData.forEach(item => {
                const marker = createMarker(item, false); // Level 1 mode
                markersClusterGroup.addLayer(marker);
            });
        }

        // Helper to create marker (Shared logic but content differs by Level) DENGAN GAMBAR
        function createMarker(item, isLevel2) {
    const isFlora = item.type === 'flora';
    const iconClass = isFlora ? 'fa-seedling' : 'fa-paw';
    
    const trackingId = item.id + (isLevel2 ? '_L2' : '_L1');
    const isVisited = gameState.visitedExplorationIds.has(trackingId);
    
    // WARNA BERDASARKAN STATUS KUNJUNGAN
    let markerColorClass = '';
    if (isVisited) {
        markerColorClass = 'marker-visited bg-gray-300';
    } else {
        markerColorClass = isFlora ? 'bg-white text-green-600' : 'bg-white text-orange-600';
    }
    
    const customIcon = L.divIcon({
        className: 'bg-transparent',
        html: `
            <div class="relative group">
                <div class="w-8 h-8 rounded-full shadow-md border border-gray-200 flex items-center justify-center text-sm hover:scale-125 transition-transform duration-300 cursor-pointer ${markerColorClass}">
                    <i class="fa-solid ${iconClass}"></i>
                </div>
            </div>
        `,
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });

    const marker = L.marker([item.lat, item.lng], { icon: customIcon });

    // GENERATE CONTENT DENGAN GAMBAR
    let descriptionHTML = "";
    const zone = getZoneFromLong(item.lng);
    
    // Gambar untuk semua level
    const imageHTML = `
        <div class="popup-image-container mb-3">
            <img src="${item.image_url}" 
                 alt="${item.name}" 
                 class="w-full h-40 object-cover"
                 onerror="this.onerror=null; this.src='${getDefaultImage(item.type)}';">
            <div class="image-caption">${item.name}</div>
        </div>
    `;
    
    if (isLevel2) {
        // LEVEL 2: Show SPECIFIC ANIMAL TRAITS dengan gambar
        const animalTraits = item.traits || "<ul><li>Ciri khas tidak tersedia</li></ul>";
        
        descriptionHTML = `
            ${imageHTML}
            <div class="mb-3">
                <p class="text-sm text-gray-700 mb-3">${item.desc || "Deskripsi tidak tersedia"}</p>
                <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                    <div class="flex items-center justify-between mb-1">
                         <p class="text-xs font-bold text-purple-700 uppercase"><i class="fa-solid fa-paw mr-1"></i> Ciri Khas Spesies</p>
                    </div>
                    <div class="text-sm text-purple-900 leading-snug font-medium pl-4 list-disc space-y-1">
                        ${animalTraits}
                    </div>
                </div>
            </div>
        `;
    } else {
        // LEVEL 1: Show General Description dengan gambar
        descriptionHTML = `
            ${imageHTML}
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded bg-gray-100 text-gray-500">${item.region || "Indonesia"}</span>
                <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded ${isFlora ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">${item.type || "fauna"}</span>
            </div>
            <p class="text-sm text-gray-700 leading-snug mb-3">${item.desc || "Deskripsi tidak tersedia"}</p>
        `;
    }

    const popupHTML = `
        <div class="font-sans">
            <div class="bg-gradient-to-r ${isVisited ? 'from-gray-500 to-gray-600' : (isFlora ? 'from-green-500 to-emerald-600' : 'from-orange-500 to-red-500')} p-3 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-lg leading-tight mb-1">${item.name || "Nama tidak tersedia"}</h3>
                        <p class="text-xs italic opacity-90">${item.sc || "Nama ilmiah tidak tersedia"}</p>
                    </div>
                    ${isLevel2 ? `<span class="ml-2 text-[10px] bg-white/20 px-1 rounded text-white border border-white/30">${zone}</span>` : ''}
                </div>
            </div>
            <div class="p-3 bg-white max-h-80 overflow-y-auto custom-scroll">
                ${descriptionHTML}
                
                ${!isVisited ? 
                    `<div class="mt-2 text-center text-xs font-bold text-emerald-600 animate-pulse bg-emerald-50 py-1 rounded">
                        <i class="fa-solid fa-plus-circle"></i> +10 Poin Baru!
                     </div>` : 
                    `<div class="mt-2 text-center text-xs font-bold text-gray-400 bg-gray-50 py-1 rounded">
                        <i class="fa-solid fa-check"></i> Sudah Dibaca
                     </div>`
                }
            </div>
        </div>
    `;
    
    marker.bindPopup(popupHTML);
    
    marker.on('popupopen', () => {
        if (!isVisited) {
            // Marker BARU dikunjungi
            gameState.visitedExplorationIds.add(trackingId);
            gameState.explorationCount++;
            gameState.score += 10;
            
            updateScoreDisplays();
            updateExplorationUI();
            
            // Update marker appearance menjadi abu-abu
            const markerElement = marker.getElement();
            if (markerElement) {
                const markerDiv = markerElement.querySelector('div > div');
                if (markerDiv) {
                    markerDiv.classList.add('marker-visited', 'bg-gray-300');
                    markerDiv.classList.remove('bg-white', 'text-green-600', 'text-orange-600');
                }
            }
            
            // Play coin sound for new marker
            playCoinSound();
            
            setTimeout(() => marker.setPopupContent(popupHTML.replace('+10 Poin Baru!', 'Sudah Dibaca').replace('text-emerald-600', 'text-gray-400').replace('bg-emerald-50', 'bg-gray-50')), 500);
        } else {
            // PERUBAHAN PENTING: Marker SUDAH PERNAH dikunjungi - kurangi 5 poin (setiap kali diklik)
            gameState.score -= 5;
            updateScoreDisplays();
            
            // Play wrong sound untuk penalti
            playWrongSound();
            
            // Tampilkan pesan penalti di popup dengan warna merah
            const penaltyPopupHTML = `
                <div class="font-sans">
                    <div class="bg-gradient-to-r from-gray-500 to-gray-600 p-3 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-lg leading-tight mb-1">${item.name || "Nama tidak tersedia"}</h3>
                                <p class="text-xs italic opacity-90">${item.sc || "Nama ilmiah tidak tersedia"}</p>
                            </div>
                            ${isLevel2 ? `<span class="ml-2 text-[10px] bg-white/20 px-1 rounded text-white border border-white/30">${zone}</span>` : ''}
                        </div>
                    </div>
                    <div class="p-3 bg-white max-h-80 overflow-y-auto custom-scroll">
                        ${descriptionHTML}
                        
                        <div class="mt-2 text-center text-xs font-bold text-red-600 animate-pulse bg-red-50 py-1 rounded border border-red-200">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i> -5 Poin! (Sudah Dibaca)
                        </div>
                    </div>
                </div>
            `;
            marker.setPopupContent(penaltyPopupHTML);
            
            // Kembalikan ke popup normal setelah 2 detik
            setTimeout(() => {
                marker.setPopupContent(popupHTML.replace('+10 Poin Baru!', 'Sudah Dibaca').replace('text-emerald-600', 'text-gray-400').replace('bg-emerald-50', 'bg-gray-50'));
            }, 2000);
        }
    });

    return marker;
}

        function updateExplorationUI() {
            document.getElementById('explore-count').innerText = `${gameState.explorationCount}/20`;
            const pct = Math.min((gameState.explorationCount / 20) * 100, 100);
            document.getElementById('progress-bar').style.width = `${pct}%`;
            
            const finishBtn = document.getElementById('btn-finish-explore');
            if (gameState.explorationCount >= 20) {
                finishBtn.disabled = false;
                finishBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                finishBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'shadow-lg', 'transform', 'hover:scale-105');
                
                if (gameState.level === 1) {
                    finishBtn.innerHTML = `Lanjut Mini Quiz <i class="fa-solid fa-arrow-right ml-1"></i>`;
                } else {
                    finishBtn.innerHTML = `Lanjut Mini Quiz <i class="fa-solid fa-flag-checkered ml-1"></i>`;
                }
            } else {
                finishBtn.disabled = true;
                finishBtn.innerHTML = `Lanjut <i class="fa-solid fa-lock ml-1"></i>`;
                finishBtn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                finishBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            }
        }

        function updateScoreDisplays() {
            document.getElementById('score-display').innerText = gameState.score;
            document.getElementById('score-display-mobile').innerText = gameState.score;
        }

        window.finishExploration = function() {
            if (gameState.level === 1) {
                // Tampilkan mini quiz level 1
                startMiniQuiz(1);
            } else if (gameState.level === 2) {
                // Tampilkan mini quiz level 2
                startMiniQuiz(2);
            }
        }

        // --- LEVEL 2: ZONE EXPLORATION ---
        async function startZoneExplorationPhase() {
            gameState.level = 2;
            gameState.explorationCount = 0; 
            
            document.getElementById('level-display').innerText = "2: Zona Biogeografi";
            document.getElementById('level1-filters').classList.add('hidden');
            document.getElementById('level2-indicator').classList.remove('hidden');
            
            setupMarkersLevel2();
            updateExplorationUI(); 
        }

        function setupMarkersLevel2() {
            if (markersClusterGroup) map.removeLayer(markersClusterGroup);

            markersClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 45,
                iconCreateFunction: function(cluster) {
                    return L.divIcon({ 
                        html: '<div class="w-10 h-10 bg-purple-600 rounded-full text-white flex items-center justify-center font-bold border-2 border-white shadow-lg">' + cluster.getChildCount() + '</div>', 
                        className: 'bg-transparent', 
                        iconSize: L.point(40, 40) 
                    });
                }
            });
            map.addLayer(markersClusterGroup);

            const faunaData = fullData.filter(d => d.type === 'fauna');
            faunaData.forEach(item => {
                const marker = createMarker(item, true); 
                markersClusterGroup.addLayer(marker);
            });
        }

        function finishZoneExploration() {
            map.removeLayer(markersClusterGroup);
            const controls = document.getElementById('exploration-controls');
            controls.style.opacity = '0';
            setTimeout(() => {
                controls.classList.add('hidden');
                window.showTutorialForLevel(3);
            }, 300);
        }

        // --- LEVEL 3: QUIZ ---
        async function startQuizPhase() {
            gameState.phase = 'quiz';
            gameState.level = 3;
            
            document.getElementById('level-display').innerText = "3: Kuis Lokasi";
            
            // Tambahkan class quiz-mode untuk styling khusus
            const clueCard = document.getElementById('clue-card');
            clueCard.classList.remove('hidden');
            clueCard.classList.add('quiz-mode');
            
            document.getElementById('quiz-hud-info').classList.remove('hidden');
            loadQuizLevel();
        }

        function loadQuizLevel() {
            if (gameState.currentQuizIndex >= quizData.length) {
                endGame();
                return;
            }
            quizMarkers.forEach(m => map.removeLayer(m));
            quizMarkers = [];
            document.getElementById('hint-text').classList.add('hidden');

            const currentSpecies = quizData[gameState.currentQuizIndex];
            document.getElementById('species-quiz-name').innerText = currentSpecies.name;
            document.getElementById('species-quiz-scientific').innerText = currentSpecies.sc;
            
            // Tambahkan gambar di deskripsi kuis (Level 3)
            const descWithImage = `
                <div class="popup-image-container mb-3">
                    <img src="${currentSpecies.image_url}" 
                         alt="${currentSpecies.name}" 
                         class="w-full h-32 object-cover"
                         onerror="this.onerror=null; this.src='${getDefaultImage('fauna')}';">
                    <div class="image-caption">${currentSpecies.name}</div>
                </div>
                <p class="text-sm text-gray-700">${currentSpecies.desc}</p>
            `;
            
            document.getElementById('species-quiz-desc').innerHTML = descWithImage;
            document.getElementById('zone-display-hud').innerText = currentSpecies.zone;
            document.getElementById('hint-text').innerText = currentSpecies.hint;
            document.getElementById('quiz-progress-badge').innerText = `${gameState.currentQuizIndex + 1}/${quizData.length}`;

            map.flyTo([-2.5, 118], 5, {duration: 1.0});
        }

        window.showHint = function() {
            document.getElementById('hint-text').classList.remove('hidden');
            gameState.score -= 5;
            updateScoreDisplays();
            
            // Play wrong sound for using hint (minus points)
            playWrongSound();
        }

        function handleMapClick(e) {
            if (gameState.phase !== 'quiz') return;
            if (!document.getElementById('result-modal').classList.contains('hidden')) return;

            const currentSpecies = quizData[gameState.currentQuizIndex];
            const targetLatLng = L.latLng(currentSpecies.lat, currentSpecies.lng);
            const distanceKm = (targetLatLng.distanceTo(e.latlng) / 1000).toFixed(0);

            const guessMarker = L.marker(e.latlng, { icon: L.divIcon({ className: 'bg-transparent', html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg pulse-marker"></div>' }) }).addTo(map);
            const targetMarker = L.marker(targetLatLng, { icon: L.divIcon({ className: 'bg-transparent', html: `<div class="text-3xl text-red-600 drop-shadow-md"><i class="fa-solid fa-location-dot"></i></div>` }) }).addTo(map);
            const line = L.polyline([e.latlng, targetLatLng], { color: 'gray', dashArray: '5, 10' }).addTo(map);
            
            quizMarkers.push(guessMarker, targetMarker, line);
            map.fitBounds(L.latLngBounds(e.latlng, targetLatLng), {padding: [50, 50], maxZoom: 8});

            let points = 0;
            if (distanceKm < 50) points = 100;
            else if (distanceKm < 200) points = 80;
            else if (distanceKm < 500) points = 50;
            else if (distanceKm < 1000) points = 20;
            else points = 10;

            gameState.score += points;
            updateScoreDisplays();

            // Play success sound for correct answer (points > 0)
            if (points > 0) {
                playSuccessSound();
            } else {
                playWrongSound();
            }

            setTimeout(() => {
                showResultModal(points, distanceKm);
            }, 1200);
        }

        function showResultModal(points, km) {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            
            modal.classList.remove('hidden');
            document.getElementById('result-distance').innerText = km + ' km';
            document.getElementById('result-points').innerText = '+' + points;

            if (points >= 80) {
                document.getElementById('result-title').innerText = "Sempurna!";
                document.getElementById('result-message').innerText = "Insting biologi Anda tajam sekali!";
                icon.innerHTML = '<i class="fa-solid fa-star text-emerald-500"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-emerald-100";
            } else if (points >= 50) {
                document.getElementById('result-title').innerText = "Bagus!";
                document.getElementById('result-message').innerText = "Tebakan yang cukup dekat.";
                icon.innerHTML = '<i class="fa-solid fa-thumbs-up text-blue-500"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-blue-100";
            } else {
                document.getElementById('result-title').innerText = "Terlalu Jauh";
                document.getElementById('result-message').innerText = "Coba perhatikan peta zonasi lagi.";
                icon.innerHTML = '<i class="fa-solid fa-map-location-dot text-orange-500"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-orange-100";
            }

            // Ubah tombol untuk lanjut ke soal berikutnya
            const btn = document.getElementById('result-btn');
            btn.innerText = "Soal Berikutnya";
            btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5";
            btn.onclick = nextLevel;
        }

        window.nextLevel = function() {
            document.getElementById('result-modal').classList.add('hidden');
            gameState.currentQuizIndex++;
            loadQuizLevel();
        }

        function endGame() {
            // Mainkan sound misi selesai untuk Level 3
            playMissionCompleteSound();
            
            // 1. Hide Game UI
            document.getElementById('clue-card').classList.add('hidden');
            document.getElementById('quiz-hud-info').classList.add('hidden');
            document.getElementById('result-modal').classList.add('hidden');

            // 2. Show Final Score in Result Modal (Temporary view before Leaderboard)
            const modal = document.getElementById('result-modal');
            modal.classList.remove('hidden');
            
            document.getElementById('result-title').innerText = "Misi Selesai!";
            document.getElementById('result-message').innerText = `Selamat ${window.playerProfile.name}, Anda telah menyelesaikan ekspedisi.`;
            document.getElementById('result-icon').innerHTML = '<i class="fa-solid fa-trophy text-yellow-500"></i>';
            document.getElementById('result-icon').className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto -mt-12 mb-4 border-4 border-white shadow-xl text-4xl bg-yellow-100";
            
            document.getElementById('result-distance').parentElement.style.display = 'none'; 
            document.getElementById('result-points').innerText = gameState.score;
            document.querySelector('#result-points').previousElementSibling.innerText = "SKOR AKHIR";

            // 3. Change Button to "Submit & View Leaderboard"
            const btn = document.getElementById('result-btn');
            btn.innerText = "Kirim Skor & Lihat Peringkat";
            btn.className = "w-full bg-purple-600 hover:bg-purple-700 text-white py-3.5 rounded-xl font-bold shadow-lg mt-4";
            btn.onclick = submitAndShowLeaderboard;
        }

        async function submitAndShowLeaderboard() {
            // Close result modal, open leaderboard modal
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('leaderboard-modal').classList.remove('hidden');
            document.getElementById('leaderboard-my-score').innerText = gameState.score;

            // Prepare Data
            const payload = {
                nama: window.playerProfile.name,
                sekolah: window.playerProfile.school,
                provinsi: window.playerProfile.province,
                skor: gameState.score,
                action: 'submit',
                timestamp: new Date().getTime()
            };

            const statusEl = document.getElementById('submission-status');

            // SUBMIT DATA
            try {
                if (useOnlineDatabase && LEADERBOARD_API_URL && LEADERBOARD_API_URL.startsWith('http')) {
                    // Gunakan CORS proxy untuk leaderboard
                    const formData = new URLSearchParams();
                    for (const key in payload) {
                        formData.append(key, payload[key]);
                    }

                    // Coba submit tanpa proxy dulu
                    const response = await fetch(LEADERBOARD_API_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json'
                        },
                        body: formData.toString()
                    });
                    
                    statusEl.innerText = "Skor terkirim! Memuat peringkat...";
                    statusEl.className = "text-center text-sm font-semibold text-green-600";
                    
                } else {
                    statusEl.innerText = "Mode offline - skor disimpan lokal";
                    statusEl.className = "text-center text-sm font-semibold text-yellow-600";
                }
            } catch (e) {
                console.error("Submission error", e);
                statusEl.innerText = "Gagal mengirim skor, menggunakan data lokal...";
                statusEl.className = "text-center text-sm font-semibold text-red-600";
            }

            // FETCH LEADERBOARD (Delay slightly to allow sheet update)
            setTimeout(fetchLeaderboard, 1500);
        }

        async function fetchLeaderboard() {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4"><i class="fa-solid fa-spinner fa-spin text-purple-600"></i> Memuat data leaderboard...</td></tr>';

            try {
                if (useOnlineDatabase && LEADERBOARD_API_URL && LEADERBOARD_API_URL.startsWith('http')) {
                    // Ambil data leaderboard
                    const response = await fetch(`${LEADERBOARD_API_URL}?action=get&sort=desc&limit=10&timestamp=${new Date().getTime()}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    const data = await response.json();
                    
                    // Pastikan data diurutkan dari skor tertinggi ke terendah
                    const sortedData = Array.isArray(data) ? 
                        data.sort((a, b) => b.skor - a.skor).slice(0, 10) : [];
                    
                    renderLeaderboardTable(sortedData);
                    document.getElementById('submission-status').classList.add('hidden');
                } else {
                    // Dummy data for demo - 10 data dengan skor tertinggi
                    const dummyData = [
                        {nama: "Budi Santoso", sekolah: "SMAN 1 Jakarta", provinsi: "DKI JAKARTA", skor: 2850},
                        {nama: window.playerProfile?.name || "Anda", sekolah: window.playerProfile?.school || "-", provinsi: window.playerProfile?.province || "-", skor: gameState.score},
                        {nama: "Siti Aminah", sekolah: "SMA 3 Bandung", provinsi: "JAWA BARAT", skor: 2450},
                        {nama: "Ahmad Rizki", sekolah: "SMK Teknologi", provinsi: "JAWA TIMUR", skor: 2200},
                        {nama: "Dewi Lestari", sekolah: "MAN 2 Yogyakarta", provinsi: "DIY", skor: 2100},
                        {nama: "Fajar Pratama", sekolah: "SMA Negeri 5 Surabaya", provinsi: "JAWA TIMUR", skor: 1950},
                        {nama: "Rina Wijaya", sekolah: "SMAN 8 Medan", provinsi: "SUMATERA UTARA", skor: 1850},
                        {nama: "Hendra Setiawan", sekolah: "SMA Katolik", provinsi: "BALI", skor: 1750},
                        {nama: "Maya Sari", sekolah: "SMAN 2 Makassar", provinsi: "SULAWESI SELATAN", skor: 1650},
                        {nama: "Rizky Ramadhan", sekolah: "SMAN 1 Denpasar", provinsi: "BALI", skor: 1550}
                    ].sort((a,b) => b.skor - a.skor).slice(0, 10);
                    
                    renderLeaderboardTable(dummyData);
                    document.getElementById('submission-status').classList.add('hidden');
                }
            } catch (e) {
                console.error("Error fetching leaderboard:", e);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center p-4">
                            <div class="text-red-500">
                                <i class="fa-solid fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Gagal memuat data leaderboard.</p>
                                <button onclick="fetchLeaderboard()" class="mt-2 px-4 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">
                                    <i class="fa-solid fa-refresh mr-1"></i>Coba Lagi
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function renderLeaderboardTable(data) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            // Ambil hanya 10 data teratas
            const top10 = data.slice(0, 10);

            top10.forEach((row, index) => {
                const rank = index + 1;
                let rankClass = "text-gray-600";
                let icon = "";
                let medalBg = "";
                
                // Atur icon untuk 3 teratas
                if (rank === 1) { 
                    rankClass = "rank-1"; 
                    icon = '<i class="fa-solid fa-crown text-yellow-400 mr-1"></i>';
                    medalBg = "bg-gradient-to-r from-yellow-100 to-yellow-50";
                }
                else if (rank === 2) { 
                    rankClass = "rank-2"; 
                    icon = '<i class="fa-solid fa-medal text-gray-300 mr-1"></i>';
                    medalBg = "bg-gradient-to-r from-gray-100 to-gray-50";
                }
                else if (rank === 3) { 
                    rankClass = "rank-3"; 
                    icon = '<i class="fa-solid fa-medal text-orange-300 mr-1"></i>';
                    medalBg = "bg-gradient-to-r from-orange-100 to-orange-50";
                }

                const tr = document.createElement('tr');
                
                // Highlight player's own score
                const isCurrentPlayer = (row.nama === window.playerProfile?.name && row.skor == gameState.score);
                
                if (isCurrentPlayer) {
                    tr.className = "bg-gradient-to-r from-purple-50 to-blue-50 border-l-4 border-purple-500";
                } else if (rank <= 3) {
                    tr.className = `${medalBg} border-l-4 ${rank === 1 ? 'border-yellow-400' : rank === 2 ? 'border-gray-300' : 'border-orange-300'}`;
                } else {
                    tr.className = "hover:bg-gray-50";
                }
                
                // Tambahkan badge untuk 3 teratas
                let rankBadge = "";
                if (rank === 1) {
                    rankBadge = '<span class="ml-2 px-2 py-0.5 text-xs bg-yellow-500 text-white rounded-full font-bold">#1</span>';
                } else if (rank === 2) {
                    rankBadge = '<span class="ml-2 px-2 py-0.5 text-xs bg-gray-400 text-white rounded-full font-bold">#2</span>';
                } else if (rank === 3) {
                    rankBadge = '<span class="ml-2 px-2 py-0.5 text-xs bg-orange-500 text-white rounded-full font-bold">#3</span>';
                }
                
                tr.innerHTML = `
                    <td class="text-center ${rankClass} font-bold">
                        <div class="flex items-center justify-center">
                            ${icon}
                            <span class="${rank <= 3 ? 'text-lg' : ''}">${rank}</span>
                            ${rankBadge}
                        </div>
                    </td>
                    <td class="font-bold ${rank === 1 ? 'text-yellow-700' : rank === 2 ? 'text-gray-700' : rank === 3 ? 'text-orange-700' : 'text-gray-700'}">
                        <div class="flex items-center">
                            ${row.nama || "Anonymous"}
                            ${isCurrentPlayer ? '<span class="ml-2 px-2 py-0.5 text-xs bg-blue-500 text-white rounded-full">Anda</span>' : ''}
                        </div>
                    </td>
                    <td class="text-gray-600">${row.sekolah || "-"}</td>
                    <td class="hidden sm:table-cell text-gray-500 text-xs uppercase tracking-wide">${row.provinsi || "-"}</td>
                    <td class="text-right">
                        <div class="font-mono font-bold text-purple-700 text-lg">${row.skor || 0}</div>
                        ${rank <= 3 ? 
                            `<div class="text-xs text-gray-500 mt-1">
                                ${rank === 1 ? '🏆 Juara 1' : rank === 2 ? '🥈 Juara 2' : '🥉 Juara 3'}
                            </div>` 
                            : ''
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Jika data kurang dari 10, tampilkan pesan
            if (top10.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center p-8">
                            <div class="text-gray-400">
                                <i class="fa-solid fa-trophy text-4xl mb-4"></i>
                                <p class="font-bold text-lg mt-2">Belum ada data</p>
                                <p class="text-sm">Jadilah yang pertama masuk leaderboard!</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
    </script>
</body>
</html>
